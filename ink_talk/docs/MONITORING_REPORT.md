# INK Talk 모니터링 보고서

본 문서는 INK Talk 앱 및 Firebase/GCP 인프라에 대한 **모니터링 전략, 지표, 대시보드, 알림** 권장 사항을 정리한 보고서입니다.

---

## 1. 모니터링 범위

| 구분 | 대상 | 목적 |
|------|------|------|
| **인프라** | Firestore, Authentication, Storage, Cloud Functions(사용 시) | 가용성·지연·에러율·할당량 |
| **앱 품질** | 크래시, ANR, 비정상 종료 | 안정성·사용자 경험 |
| **비즈니스/감사** | audit_logs, 핵심 플로우(가입, 친구, 채팅방) | 이상 행위·운영 확인·복구 |
| **비용** | 읽기/쓰기/스토리지 사용량 | 예산·비용 이상 탐지 |

---

## 2. Firebase / GCP 지표

### 2.1 Firestore

| 지표 | 설명 | 권장 알림 임계값(참고) |
|------|------|------------------------|
| **쓰기 작업 수** | 문서 생성·업데이트·삭제 | 일일 급증 시 알림(비용) |
| **읽기 작업 수** | 문서·쿼리 읽기 | 일일 급증 또는 비정상 패턴 |
| **실패한 작업** | 권한/할당량/네트워크 오류 | 실패 건수 > 0 또는 N건/분 |
| **지연 시간** | 쓰기/읽기 응답 시간 | p99 지연 급증(예: 5초 초과) |

**확인 경로**: Firebase Console → Firestore → 사용량 탭  
**GCP**: Cloud Monitoring → Firestore 메트릭

### 2.2 Authentication

| 지표 | 설명 | 권장 알림 |
|------|------|-----------|
| **가입 수** | 신규 사용자 | 급증/급감(선택) |
| **로그인 시도** | 성공/실패 | 실패율 상승(예: 10% 초과) |
| **계정 삭제** | deleteAccount 호출 | 건수 추이(감사) |

**확인 경로**: Firebase Console → Authentication → 사용량

### 2.3 Storage

| 지표 | 설명 | 권장 알림 |
|------|------|-----------|
| **저장 용량** | 업로드된 파일 총량 | 용량 한도 대비 80% 등 |
| **다운로드/업로드 트래픽** | 바이트 전송량 | 비정상 급증 |

**확인 경로**: Firebase Console → Storage → 사용량

### 2.4 앱 품질 (Crashlytics)

- **크래시율**: 세션 대비 크래시 비율  
- **ANR(응답 없음)**: 메인 스레드 정지  
- **비정상 종료**: 처리되지 않은 예외  

**권장**: 크래시율 > 0.5% 또는 신규 크래시 발생 시 알림

---

## 3. 애플리케이션·감사 로그 기반 모니터링

### 3.1 audit_logs 컬렉션 활용

감사 로그(`audit_logs`)는 **append-only**로 저장되며, 아래 용도로 활용할 수 있습니다.

| 용도 | 방법 |
|------|------|
| **이벤트 추이** | `eventType`별 일/시간 단위 집계(채팅방 생성, 친구 요청, 스트로크 삭제 등) |
| **이상 탐지** | 특정 사용자의 과도한 삭제·생성 빈도, 비정상 시간대 활동 |
| **운영·복구** | 특정 문서/방에 대한 생성·삭제 이력 추적 |

**집계 예시(쿼리/스크립트)**  
- Firestore에서 `audit_logs`를 `eventType`, `timestamp` 기준으로 조회 후 집계  
- BigQuery로 내보내기 시: `eventType`, `userId`, `timestamp` 기준 대시보드/알림 구성

### 3.2 핵심 플로우 지표(권장)

| 지표 | 데이터 소스 | 참고 |
|------|-------------|------|
| 일일 활성 사용자(DAU) | Auth 또는 audit_logs의 고유 userId | 로그인/주요 이벤트 기준 |
| 채팅방 생성 수 | audit_logs `eventType=room_created` | 일/주 단위 추이 |
| 친구 요청/수락/거절 | audit_logs `friend_request_*` | 악용·스팸 탐지 |
| 스트로크/텍스트/미디어 삭제 빈도 | audit_logs `*_deleted` | 대량 삭제 이상 탐지 |

---

## 4. 대시보드 권장 구성

### 4.1 Firebase Console 기본 활용

- **Firestore**: 사용량(읽기/쓰기), 오류(있는 경우)
- **Authentication**: 로그인 방법별 사용량, 오류
- **Storage**: 저장 용량, 다운로드/업로드
- **Crashlytics**: 크래시율, 상위 이슈, 영향 받는 버전

### 4.2 GCP Cloud Monitoring 대시보드(선택)

- **한 화면에 모으기**: Firestore 읽기/쓰기, Auth 요청, Storage 바이트, Cloud Functions 호출(사용 시)
- **시간 범위**: 24시간, 7일, 30일
- **필요 시**: audit_logs 기반 지표를 BigQuery로 집계 후 Data Studio/Looker로 시각화

### 4.3 대시보드 체크리스트

- [ ] Firestore 읽기/쓰기 추이
- [ ] Authentication 로그인 성공/실패
- [ ] Storage 용량 및 트래픽
- [ ] 앱 크래시율·ANR
- [ ] audit_logs 이벤트 타입별 건수(일/주)
- [ ] 비용 추이(예: Firestore·Storage 청구액)

---

## 5. 알림(Alert) 권장 사항

| 우선순위 | 조건 | 조치 |
|----------|------|------|
| **P0** | Firestore/Auth/Storage 가용성 장애 또는 오류율 급증 | 즉시 확인·복구, 필요 시 사용자 공지 |
| **P1** | 크래시율 임계값 초과, 신규 크래시 다수 발생 | 당일 내 원인 분석·핫픽스 검토 |
| **P1** | 읽기/쓰기 비정상 급증(비용·DDoS 의심) | 규칙·할당량·제한 검토 |
| **P2** | 일일 비용 예산 대비 초과 | 원인 분석 및 비용 최적화 |
| **P2** | audit_logs 특정 이벤트 이상 빈도(예: 대량 삭제) | 로그 검토·이상 사용자 확인 |

**설정 경로**  
- **GCP**: Cloud Monitoring → Alerting → 정책 생성  
- **Firebase**: Console 내 사용량/오류 추이 확인 후, GCP Alerting과 연동

---

## 6. 로그·에러 수집

| 항목 | 권장 |
|------|------|
| **클라이언트** | Flutter/Crashlytics 자동 수집; 중요 비즈니스 실패 시 로그 메시지·컨텍스트 추가 |
| **서버/백엔드** | Cloud Functions·Cloud Run 사용 시 구조화 로그 + Cloud Logging |
| **감사** | audit_logs는 수정/삭제 불가(규칙으로 차단) 유지 → 별도 삭제 없이 보관 |

---

## 7. 정기 점검 체크리스트

| 주기 | 항목 |
|------|------|
| **일일** | 크래시·치명적 오류 여부, Firestore/Auth 오류 건수 |
| **주간** | 사용량·비용 추이, audit_logs 이벤트 요약, 상위 오류 유형 |
| **월간** | 할당량 대비 사용률, 백업·PITR 동작 확인, 알림 규칙 유효성 검토 |

---

## 8. 관련 문서

- **데이터 보존·복구**: `docs/DATA_RETENTION_AND_RECOVERY.md`  
  - 소프트 삭제, audit_logs 설계, PITR·예약 백업
- **Firestore 규칙**: `firestore.rules`  
  - audit_logs append-only 규칙 포함

---

## 9. 요약

| 구분 | 내용 |
|------|------|
| **인프라** | Firestore·Auth·Storage 사용량·오류·지연 모니터링, 임계값 초과 시 알림 |
| **앱** | Crashlytics 크래시·ANR 추적, 신규 이슈 시 알림 |
| **감사** | audit_logs로 생성·삭제 이력 보존, 집계·이상 탐지·복구에 활용 |
| **운영** | 대시보드·알림·정기 점검으로 가용성·비용·보안 균형 유지 |

위 항목을 기준으로 단계적으로 대시보드와 알림을 구축·조정하면 됩니다.
