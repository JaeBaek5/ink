# 개발 보고서 — 2025년 2월 9일

## 1. 개요

INK Talk 앱의 다크 모드 대응, 설정 기능 보완, 친구/차단 관련 기능 수정 및 오류 대응을 진행했습니다.

---

## 2. 진행한 개발 내용

### 2.1 다크 모드 — 좌측 사이드바

**문제**  
탭 화면에서 다크 모드일 때 좌측 사이드바(네비게이션 레일)가 라이트 모드로 고정되어 보임.

**조치**  
- **파일**: `lib/widgets/layouts/adaptive_scaffold.dart`
- NavigationRail: `backgroundColor` → `colorScheme.surface`, 아이콘/라벨 → `onSurface` / `onSurfaceVariant`
- VerticalDivider, 하단 탭 상단 보더 → `colorScheme.outline` 사용

**결과**  
다크 모드에서도 좌측 사이드바가 테마에 맞게 표시됨.

---

### 2.2 다크 모드 — 채팅 탭 목록

**문제**  
채팅 탭 목록 글씨가 다크 모드에서 검정이라 배경과 구분되지 않음.

**조치**  
- **파일**: `lib/widgets/chat/puzzle_card.dart`, `lib/screens/home/tabs/chat_tab.dart`
- PuzzleCard: 방 이름·미리보기·시간·멤버 수·카드 테두리·프로필 placeholder를 `Theme.of(context).colorScheme` 기반으로 변경
- 빈 목록 문구·아이콘: `colorScheme.onSurfaceVariant` 사용

**결과**  
다크 모드에서도 채팅 목록 텍스트가 읽기 좋게 표시됨.

---

### 2.3 기본 펜 설정 기능

**문제**  
설정 탭의 "기본 펜 설정"이 `onTap: () {}` 로 비어 있어 동작하지 않음.

**조치**  
1. **SettingsService** (`lib/services/settings_service.dart`)  
   - `getDefaultPenColorValue` / `setDefaultPenColorValue`, `getDefaultPenWidth` / `setDefaultPenWidth` 추가 (SharedPreferences 저장)
2. **DefaultPenScreen** (`lib/screens/settings/default_pen_screen.dart`)  
   - 프리셋 색상 선택, 굵기 슬라이더(1~24), 미리보기, 저장 시 스낵바
3. **CanvasController** (`lib/screens/canvas/canvas_controller.dart`)  
   - `applyDefaultPenSettings({Color? color, double? width})` 추가
4. **CanvasScreen**  
   - 채팅방 진입 후 `_applyDefaultPenSettings()` 로 저장된 기본 펜 적용
5. **설정 탭**  
   - "기본 펜 설정" 탭 → `DefaultPenScreen` 이동 연결

**결과**  
설정에서 저장한 기본 펜 색·굵기가 캔버스 진입 시 펜1에 적용됨.

---

### 2.4 다크 모드 — 친구 탭 내 프로필

**문제**  
친구 탭에서 "내 프로필" 이름·부제목이 다크 모드에서 검정/회색으로 잘 안 보임.

**조치**  
- **파일**: `lib/screens/home/tabs/friends_tab.dart`
- `_buildMyProfileSection`: 제목 → `colorScheme.onSurface`, 부제목 → `colorScheme.onSurfaceVariant`

**결과**  
다크 모드에서도 내 프로필 영역이 잘 보임.

---

### 2.5 친구 별명 설정 오류

**문제**  
별명 설정/삭제 시 Firestore 관련 오류 발생.

**원인**  
- `update({'nickname': null})` 사용 시, Firestore에서 null 처리 방식·보안 규칙 등으로 오류 가능
- 필드 삭제는 `FieldValue.delete()` 사용이 안전

**조치**  
- **파일**: `lib/services/friend_service.dart`
- `updateFriendNickname`:  
  - 별명 제거 시 `'nickname': FieldValue.delete()`  
  - 수락된 친구 문서만 수정하도록 `where('status', isEqualTo: FriendStatus.accepted.name)` 추가
- **파일**: `lib/models/friend_model.dart`  
  - (이번 날짜에 별명 관련 모델은 기존 구조 유지, 서비스만 수정)

**결과**  
별명 저장·삭제가 안정적으로 동작함.

---

### 2.6 친구 목록이 비어 보이는 현상

**문제**  
재설치·별명 수정 등 이후 친구 목록이 비어 보이고, 다른 기기에서는 친구가 보이는 경우 있음.

**원인**  
- `getFriendsStream`에서 `where('hidden', isNotEqualTo: true)` 사용
- 과거에 생성된 친구 문서에는 `hidden` 필드가 없을 수 있어, 쿼리 결과에서 제외될 수 있음

**조치**  
- **파일**: `lib/services/friend_service.dart`
- `getFriendsStream`:  
  - 쿼리에서는 `hidden` 조건 제거  
  - 스냅샷 수신 후 `doc.data()['hidden'] != true` 로 메모리에서 필터링
- **차단 해제**  
  - 기존: 차단 해제 시 해당 문서 삭제 → 친구 관계 소멸  
  - 변경: `status`를 `blocked` → `accepted`로 복구하고, 상대방 쪽 문서가 없으면 재생성

**결과**  
`hidden` 필드가 없는 과거 문서도 친구 목록에 포함되고, 차단 해제 시 다시 친구 목록에 나타남.

---

### 2.7 친구 목록 탭 동작 및 차단 흐름 정리

**요구사항**  
- 한 번 누르면 대화로 넘어가는 동작 제거  
- 길게 눌러서 시트에서 "채팅하기"만 제공  
- 차단 시 친구 목록에서 숨기고, 설정 > 친구 차단 관리에서만 보이게  
- 차단 해제 시 다시 친구 목록에 표시  
- 차단된 사용자는 자신이 차단당했는지 알 수 없음 (알림만 이후 비수신 예정)

**조치**  
1. **친구 탭** (`lib/screens/home/tabs/friends_tab.dart`)  
   - ListTile `onTap` 제거, `onLongPress`만 유지 → 길게 눌렀을 때만 옵션 시트 표시
2. **차단** (`lib/services/friend_service.dart`)  
   - 내 문서만 `status: blocked` + `blockedAt` 저장  
   - 상대 문서는 수정/삭제하지 않음 (차단 여부 비공개)
3. **차단 해제**  
   - 내 문서만 `status: accepted`, `hidden: false` 등 복구  
   - 상대 문서는 이미 유지 중이므로 별도 재생성 제거
4. **시트 context 오류**  
   - 시트를 닫은 뒤에도 확인 다이얼로그·차단 로직이 동작하도록, 시트 밖의 `scaffoldContext`를 저장해 사용  
   - 차단 확인 문구: "친구 목록에서 차단 관리로 이동하며, 이후 알림만 받지 않습니다." 등으로 정리

**결과**  
친구는 길게 눌러서만 채팅 가능하고, 차단/해제 흐름이 요구사항대로 동작함.

---

### 2.8 친구 목록 — 상태 메시지 표시

**요구사항**  
친구 이름(별명) 오른쪽에 상태 메시지를 같이 보여 주기.

**조치**  
- **파일**: `lib/screens/home/tabs/friends_tab.dart`
- `_buildFriendTile`: title을 Row로 변경  
  - 이름(별명): `Expanded(flex: 2)`  
  - 상태 메시지: `Expanded`, 작은 글씨, `textAlign: TextAlign.end`  
  - 상태 메시지 없으면 이름만 표시

**결과**  
같은 줄에서 이름과 상태 메시지를 함께 확인 가능.

---

### 2.9 차단 기능 미동작

**문제**  
차단 버튼을 눌러도 반응이 없거나 실패함.

**원인**  
1. **Context**  
   - 옵션 시트를 닫은 뒤 확인 다이얼로그·차단 API 호출에 시트의 `context` 사용  
   - 시트가 닫히면 해당 context가 dispose되어, 다이얼로그·스낵바 등에서 "Looking up a deactivated widget's ancestor" 유형 오류 가능
2. **상대 문서 삭제**  
   - 차단 시 상대방 쪽 문서를 삭제하려다 권한/실패 시 전체 실패로 이어질 수 있음  
   - 요구사항상 "차단된 사용자는 확인 불가"이므로 상대 문서는 건드리지 않는 것이 맞음

**조치**  
- 시트 builder에서는 `sheetContext`, 시트 밖에서는 `scaffoldContext`를 구분해 사용  
- 확인 다이얼로그·차단 호출·스낵바에는 `scaffoldContext`만 사용  
- `blockFriend`에서 상대 문서 삭제/수정 로직 제거, 내 문서만 `status: blocked` + `blockedAt` 저장  
- Firestore 복합 인덱스: `friends` 컬렉션에 `(userId, friendId)` 인덱스 추가 (`firestore.indexes.json`)

**결과**  
차단 시 친구 목록에서 사라지고, 친구 차단 관리에만 표시되며, 차단 해제 시 다시 친구 목록에 나타남.

---

### 2.10 차단 중 메시지 — 기록 및 해제 시 채팅 표시

**요구사항**  
- 차단해도 채팅방은 유지  
- 차단 기간 중 상대가 보낸 새 메시지는 "친구 차단 관리" 쪽에만 기록(개수 표시)  
- 차단 해제 시 해당 메시지들이 채팅 탭(캔버스)에 보이도록

**조치** (클라이언트 기준, 서버 미사용)  
1. **blockedAt 저장**  
   - `FriendModel`에 `blockedAt` 추가  
   - `blockFriend` 시 `blockedAt: Timestamp.fromDate(now)` 저장
2. **캔버스에서 차단한 사용자 메시지 숨김**  
   - `CanvasController.initialize`에 `blockedUserId`, `blockedAt` 옵션 추가  
   - 스트로크/텍스트 스트림 수신 시, `senderId == blockedUserId` 이고 `createdAt > blockedAt` 인 항목 제거 후 반영  
   - `CanvasScreen`에서 1:1 방이고 상대가 차단 목록에 있으면 해당 친구의 `blockedAt` 전달
3. **친구 차단 관리 탭**  
   - `RoomService.getDirectRoom` (1:1 방만 조회) 추가  
   - `StrokeService.countStrokesFromSenderAfter`, `TextService.countTextsFromSenderAfter` 추가  
   - 각 차단 사용자에 대해 "차단 기간 중 받은 메시지 N건 (해제 시 채팅에 표시됨)" 표시
4. **차단 해제**  
   - 해제 시 `blockedUsers`에서 제거되므로, 캔버스 초기화 시 `blockedUserId`/`blockedAt` 미전달  
   - 기존 방 데이터는 그대로 두고 필터만 제거되어, 해제 후 채팅 탭에서 차단 기간 메시지까지 모두 표시

**결과**  
차단 중에는 상대 메시지가 캔버스에 안 보이고, 친구 차단 관리에서 건수만 확인 가능하며, 해제 후 채팅에서 모두 보임.

---

### 2.11 차단 해제 시 FlutterError (deactivated widget ancestor)

**문제**  
차단 해제 시 아래 오류 발생.

```
FlutterError (Looking up a deactivated widget's ancestor is unsafe.
At this point the state of the widget's element tree is no longer stable.
To safely refer to a widget's ancestor in its dispose() method, save a reference...)
```

**원인**  
- 차단 해제 후 해당 타일이 리스트에서 제거됨  
- 그 타일의 `context`가 비활성화된 뒤에도 `ScaffoldMessenger.of(context)` 등에 사용됨

**조치**  
- **파일**: `lib/screens/settings/blocked_users_screen.dart`
- **Context 구분**  
  - `scaffoldContext`: `build()`의 `context` (화면 전체) → 차단 해제 콜백·스낵바용  
  - `itemContext`: ListView.builder의 item context → 타일 UI·FutureBuilder용
- **차단 해제**  
  - `_unblock`에는 `scaffoldContext`만 전달  
  - 스낵바: `ScaffoldMessenger.maybeOf(scaffoldContext)?.showSnackBar(...)` 사용  
  - `await` 후 `if (!mounted) return;` 한 번 더 수행
- **차단 기간 메시지 수**  
  - `_getBlockedPendingCount`에 `context`를 인자로 넘기고, 비동기 진입 직후 `if (!context.mounted) return 0;` 처리

**결과**  
차단 해제 후에도 오류 없이 스낵바만 표시되고, 목록이 정상 갱신됨.

---

## 3. 발생한 오류와 대처 요약

| 구분 | 현상 | 원인 | 대처 |
|------|------|------|------|
| 별명 저장/삭제 | Firestore 오류 | `update({'nickname': null})` 사용 | `FieldValue.delete()` 사용, 수락된 친구 문서만 대상 |
| 친구 목록 비어 보임 | 재설치 등 후 목록 빈 경우 | `hidden` 필드 없는 과거 문서가 쿼리에서 제외 | 쿼리에서 `hidden` 제거, 메모리에서만 필터링 |
| 차단 무반응 | 버튼 눌러도 동작 없음 | 시트 닫힌 뒤 시트 context 사용 | `scaffoldContext` 저장해 다이얼로그·API·스낵바에만 사용 |
| 차단 해제 후 크래시 | deactivated widget ancestor | 해제 후 제거된 타일의 context 사용 | scaffoldContext/itemContext 분리, `maybeOf`, `mounted` 재확인 |

---

## 4. 수정·추가된 주요 파일

- `lib/widgets/layouts/adaptive_scaffold.dart` — 다크 모드(레일·구분선·하단 탭)
- `lib/widgets/chat/puzzle_card.dart` — 다크 모드(채팅 카드)
- `lib/screens/home/tabs/chat_tab.dart` — 빈 목록 다크 모드
- `lib/services/settings_service.dart` — 기본 펜 저장/로드
- `lib/screens/settings/default_pen_screen.dart` — 기본 펜 설정 화면 (신규)
- `lib/screens/canvas/canvas_controller.dart` — applyDefaultPenSettings, 차단 필터
- `lib/screens/canvas/canvas_screen.dart` — 기본 펜 적용, 차단 필터 전달
- `lib/screens/home/tabs/settings_tab.dart` — 기본 펜 설정 진입
- `lib/screens/home/tabs/friends_tab.dart` — 다크 모드, 탭/롱프레스, 상태 메시지, 시트 context
- `lib/services/friend_service.dart` — 별명, 차단/해제, blockedAt, getDirectRoom
- `lib/models/friend_model.dart` — blockedAt 필드
- `lib/providers/room_provider.dart` — getDirectRoom
- `lib/services/room_service.dart` — getDirectRoom
- `lib/services/stroke_service.dart` — countStrokesFromSenderAfter
- `lib/services/text_service.dart` — countTextsFromSenderAfter
- `lib/screens/settings/blocked_users_screen.dart` — 차단 기간 메시지 수, context 분리
- `firestore.indexes.json` — friends (userId, friendId) 등

---

## 5. 비고

- 차단 기간 중 메시지 "기록"은 현재 클라이언트에서 표시만 숨기고, 건수는 방·스트로크/텍스트 쿼리로 계산하는 방식입니다. 서버에서 차단 시 메시지를 별도 저장하고 해제 시 채팅에 반영하는 방식은 미구현입니다.
- Firestore 복합 인덱스 추가 후 `firebase deploy --only firestore:indexes` 배포가 필요할 수 있습니다.
- strokes 서브컬렉션의 senderId·createdAt·isDeleted 조건 쿼리 사용 시, 인덱스 미설정이면 콘솔 안내대로 인덱스를 생성해야 합니다.

---

*작성일: 2025년 2월 9일*
