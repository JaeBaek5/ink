# 2026년 2월 6일 작업 보고서

이번 대화에서 진행한 수정·추가·보안 복구·문서화 내용을 정리한 보고서입니다.

---

## 1. 도형 길게 누르면 삭제 + Undo/Redo 10회 제한

### 요약
- **도형**: 손(터치)으로 길게 누르면 해당 도형 삭제.
- **뒤로가기/앞으로가기**: 최대 **10단계**만 유지 (스택 10개 초과 시 가장 오래된 항목 제거).

### 수정 내용
- **CanvasController**: `getShapeAtPoint(Offset)`, `_shapeContainsPoint`, `_distanceToSegment` 추가. 선/화살표/사각형/타원 히트테스트 후 도형 반환.
- **DrawingCanvas**: 롱프레스 시 `getShapeAtPoint`로 도형 검사 → 있으면 `deleteShape(shapeId)` 호출 후 return (스트로크 태그 메뉴는 도형 없을 때만).
- **CanvasController**: `undoRedoLimit = 10`. `_undoStack`/`_redoStack`에 push 시 `length >= 10`이면 `removeAt(0)` 후 추가.

---

## 2. 뒤로가기/앞으로가기 통합 (이동 제외, 펜·도형·사진·지우개)

### 요약
- **캔버스 이동(pan)** 은 Undo/Redo 스택에 넣지 않음.
- **펜(스트로크)·도형·사진(미디어)·지우개**만 스택에 넣고, **Redo**까지 동작하도록 구현.

### 추가·수정 내용
- **서비스**: `StrokeService.restoreStroke`, `ShapeService.restoreShape`, `MediaService.restoreMedia` 추가 (소프트 삭제 복구).
- **CanvasController**:
  - `_UndoEntryType`(stroke, shape, media), `_UndoEntry(type, id, isAdd)` 도입.
  - `_undoStack` / `_redoStack`을 `List<_UndoEntry>`로 변경.
  - **isAdd true**: 추가(펜/도형/사진) → Undo 시 삭제, Redo 시 복구.
  - **isAdd false**: 삭제(지우개/도형 삭제/미디어 삭제) → Undo 시 복구, Redo 시 삭제.
  - 스트로크 저장·재전송, 도형 저장(`endShape`), 미디어 저장(이미지/영상/PDF), 도형 삭제(`deleteShape`), 미디어 삭제(`deleteMedia`), 지우개 삭제 시 스택에 `_UndoEntry` push.
  - `undo()` / `redo()`: `_performDelete`, `_performRestore` 호출 후 반대 스택에 항목 push.
- **도형/미디어 삭제** 시에도 Undo 스택에 넣어 되돌리기 가능.

---

## 3. 뒤로가기 버튼 반응 없음 수정

### 요약
- 뒤로가기(Undo) 버튼이 비활성으로만 보이거나 눌러도 반응이 없던 현상 수정.

### 원인
- 스트로크 저장 **성공** 시 `_undoStack`에만 추가하고 **`notifyListeners()`를 호출하지 않음** → UI가 갱신되지 않아 버튼이 계속 비활성.
- 펜 툴바의 Undo/Redo 버튼이 컨트롤러를 **구독하지 않음** → 스택이 바뀌어도 버튼 상태가 갱신되지 않음.

### 수정 내용
- **CanvasController**: `endStroke()` 성공 분기 마지막에 **`notifyListeners()`** 추가.
- **PenToolbar**: Undo/Redo 영역을 **`ListenableBuilder(listenable: controller)`** 로 감싸 스택 변경 시 버튼 활성/비활성 갱신.
- **CanvasController**: `undo()` / `redo()` 내부 **try/catch** 추가. 실패 시 항목 복원 후 **`notifyListeners()`** 호출.
- **CanvasScreen** AppBar: Undo/Redo 버튼 `onPressed`를 `() => _canvasController.undo()` 형태로 명시.

---

## 4. 손 터치로 손글씨 안 되게 복구

### 요약
- **손글씨(펜/지우개)** 는 **스타일러스·마우스**만 인식. **손가락 터치**는 그리기로 사용하지 않고, 한 손가락 드래그는 **캔버스 이동(팬)** 만 수행.

### 수정 내용
- **DrawingCanvas**: `_onPointerDown` / `_onPointerMove` / `_onPointerUp`에서 그리기·도형 시작/이동/종료 조건을 **스타일러스 또는 마우스**만 허용하도록 복구 (터치 제거).
- **DrawingCanvas**: `_onScaleUpdate`에서 한 손가락 이동은 기존대로 스타일러스/마우스가 아닐 때만 `pan()` 호출.

---

## 5. 프로필 편집 — 표시 ID 중복검사·아이디 만들기

### 요약
- 설정 → 프로필 편집에서 **표시 ID**를 만들고 **중복 검사**할 수 있도록 기능 추가.

### 추가·수정 내용
- **UserService**:
  - **`checkVisibleIdAvailable(visibleId, {excludeUid})`**: 다른 사용자가 해당 ID를 쓰지 않으면 true (본인 UID 제외 가능).
  - **`generateAvailableVisibleId()`**: `ink_` + 랜덤 8자 생성 후 중복 아닌 ID 반환 (최대 10회 시도).
- **ProfileEditScreen**:
  - 표시 ID **형식**: 영문 소문자·숫자·언더스코어만 **4~24자** (`_isValidVisibleId`).
  - **중복 검사** 버튼: 입력 ID 검사 후 "사용 가능한 ID입니다" / "이미 사용 중인 ID입니다" 표시.
  - **아이디 만들기** 버튼: 사용 가능한 랜덤 ID 생성 후 필드에 넣고 사용 가능 상태로 표시.
  - 저장 시에도 동일 형식·중복 검사 로직 적용.

---

## 6. 프로필 편집 화면 — "사용자 정보를 불러올 수 없습니다" 해결

### 요약
- 로그인된 상태인데 프로필 편집 진입 시 **"사용자 정보를 불러올 수 없습니다. 로그인 상태를 확인해 주세요."** 만 보이던 문제 수정.

### 원인
- 로그인은 **Firebase Auth**만 사용하고, **Firestore `users` 컬렉션**에 사용자 문서를 생성하는 `createOrUpdateUser`가 앱에서 **한 번도 호출되지 않음** → `getUserById(uid)`가 null 반환.

### 수정 내용
- **ProfileEditScreen** `_loadUser()`:
  - `getUserById(uid)`가 **null**이고 `firebaseUser != null`이면 **`UserService().createOrUpdateUser(firebaseUser)`** 호출로 Firestore 사용자 문서 생성 후, 다시 로드해 편집 화면 표시.
- **로딩/에러 메시지**:
  - 로딩 중: "프로필을 불러오는 중..." 문구 추가.
  - 사용자 없음: "사용자 정보를 불러올 수 없습니다. 다시 시도해 주세요." 및 `_error`가 있으면 해당 메시지 표시.
- **visibleId**: `user.visibleId.isNotEmpty ? user.visibleId : ''` 로 null/빈 값 처리.
- 표시 ID 입력·버튼 영역을 **세로 배치**로 조정해 작은 화면에서도 레이아웃 깨지지 않도록 수정.

---

## 7. 보안 규칙 복구 + 테스트 채팅방 생성 삭제

### 요약
- **Storage**: 테스트용으로 완화했던 규칙을 **방 멤버만 허용**하도록 복구.
- **테스트 채팅방 생성** 기능 제거.

### 수정 내용
- **storage.rules**:
  - `rooms/{roomId}/media/{fileName}` 에 대해  
    `request.auth != null && request.auth.uid in firestore.get(/databases/(default)/documents/rooms/$(roomId)).data.memberIds` 로 **해당 채팅방 멤버만** 읽기·쓰기 허용.
- **설정 탭** (`settings_tab.dart`):
  - "개발자" 섹션 및 **"테스트 채팅방 생성"** ListTile 제거.
  - **`_createTestRoom`** 메서드 제거.
  - 사용하지 않는 import 제거: `RoomProvider`, `CanvasScreen`.
- **RoomProvider**: **`createTestRoom(String userId)`** 메서드 제거.
- **RoomService**: **`createTestRoom(String userId)`** 메서드 제거. 사용하지 않는 `import 'package:flutter/foundation.dart'` 제거.

---

## 8. Firestore / Realtime Database 규칙 파일 추가

### 요약
- Firebase 콘솔에서 직접 업데이트할 수 있도록 **규칙 내용을 파일로** 정리.

### 추가된 파일
- **firestore.rules**  
  - 로그인 사용자만 전체 문서 read/write:  
    `match /{document=**} { allow read, write: if request.auth != null; }`
- **database.rules.json** (Realtime Database)  
  - 전체 읽기·쓰기 거부:  
    `"rules": { ".read": false, ".write": false }`  
  - 앱은 Realtime Database를 사용하지 않으므로 차단 상태 유지.

---

## 9. 기타 기록 (문서/질의)

- **Realtime Database**: 앱은 **Firestore**만 사용하며 `.snapshots()` 로 실시간 동기화. Realtime Database 미사용 확인.
- **실시간 채팅**: Firestore만으로 실시간 채팅·캔버스 동기화 가능함을 정리.
- **Realtime DB 추가 시 속도**: 체감상 크게 빨라지지 않으며, 현재 구조에서는 Firestore만으로 충분하다는 내용 정리.

---

## 수정·추가·삭제된 파일 목록

| 파일 | 변경 요약 |
|------|-----------|
| `lib/screens/canvas/canvas_controller.dart` | getShapeAtPoint, _shapeContainsPoint, _distanceToSegment, UndoEntry/통합 undo·redo, undo 10회 제한, endStroke 시 notifyListeners, undo/redo try/catch |
| `lib/widgets/canvas/drawing_canvas.dart` | 롱프레스 시 도형 삭제, 손 터치 그리기 제거(스타일러스·마우스만) |
| `lib/widgets/canvas/pen_toolbar.dart` | Undo/Redo ListenableBuilder, 버튼 콜백 명시 |
| `lib/screens/canvas/canvas_screen.dart` | AppBar Undo/Redo onPressed 명시 |
| `lib/services/stroke_service.dart` | restoreStroke 추가 |
| `lib/services/shape_service.dart` | restoreShape 추가 |
| `lib/services/media_service.dart` | restoreMedia 추가 |
| `lib/screens/settings/profile_edit_screen.dart` | ID 형식 검사, 중복 검사·아이디 만들기 버튼, createOrUpdateUser로 문서 생성, 로딩/에러 메시지·레이아웃 보강 |
| `lib/services/user_service.dart` | checkVisibleIdAvailable, generateAvailableVisibleId 추가 |
| `lib/screens/home/tabs/settings_tab.dart` | 테스트 채팅방 생성 UI·_createTestRoom 제거, 관련 import 제거 |
| `lib/providers/room_provider.dart` | createTestRoom 제거 |
| `lib/services/room_service.dart` | createTestRoom 제거, foundation import 제거 |
| `storage.rules` | 방 멤버만 허용하도록 firestore.get(memberIds) 복구 |
| `firestore.rules` | 신규 생성 — 로그인 사용자만 read/write |
| `database.rules.json` | 신규 생성 — Realtime DB 전부 거부 |

---

## 발생한 오류·이슈 요약

| 현상 | 원인 | 조치 |
|------|------|------|
| 뒤로가기 버튼 반응 없음 | endStroke 성공 시 notifyListeners 미호출, 펜 툴바 미구독 | 성공 시 notifyListeners 추가, ListenableBuilder 적용 |
| 프로필 편집 "사용자 정보를 불러올 수 없습니다" | Firestore users 문서 미생성 | 프로필 로드 시 getUserById null이면 createOrUpdateUser 호출 후 재로드 |
| 손 터치로 손글씨 써짐 | 이전에 터치도 그리기로 넣었던 변경 | 스타일러스·마우스만 그리기로 복구 |

---

*보고서 작성일: 2026년 2월 6일*
