# 2026년 2월 10일 캔버스·사진·핸들·메뉴 작업 보고서

오늘 진행한 캔버스/사진 관련 수정, 발생한 오류, 조치사항을 정리한 보고서입니다.

---

## 1. 진행한 작업 요약

### 1.1 반전·회전 핸들 위치 및 형태
- **좌/우 반전**, **상/하 반전** 핸들 위치를 **1/5** 지점으로 조정 (넓이 핸들과 겹치지 않도록).
- 리사이즈·반전·회전 **모든 핸들을 원형**으로 통일 (`BoxShape.circle`).

### 1.2 사진 선택·롱프레스 동작 정리
- **탭**으로 선택/메뉴 진입 제거 → 이동 시 방해되지 않도록 함.
- **0.5초 롱프레스**: 해당 사진 **선택 + 크기 조정 모드**(핸들 표시).
- **캔버스 롱프레스** 시 미디어 위면 동일하게 선택 + 크기 조정 (MediaWidget보다 캔버스가 먼저 롱프레스를 받으므로 여기서 처리).
- **선택된 상태에서만** 사진 이동 가능. 선택되지 않으면 터치·드래그 시 **캔버스만 스크롤**.

### 1.3 선택 시 하단 액션 바
- 사진 선택 시 **사진 아래쪽**에 **복사, 삭제, 레이어 앞, 레이어 뒤, 자르기** 메뉴 바 표시.
- **반전·회전 핸들**은 유지 (위쪽 회전, 좌측 상/하 반전, 하단 좌/우 반전).
- **메뉴 바**는 **화면 기준 아래쪽 고정** (사진 회전과 무관). 사진 뷰에서 **하단(최하단 Y)** + **이미지 높이 50%** 이격으로 배치.
- **자르기**는 현재 "준비 중" 스낵바만 표시.

### 1.4 미디어 복사(duplicate) 기능
- **CanvasController**에 **`duplicateMedia(mediaId)`** 추가.
- 동일 URL·속성으로 새 미디어 생성, 위치만 (24, 24) 오프셋, zIndex는 최상단.

---

## 2. 캔버스·사진 관련 발생 오류

| 현상 | 원인 |
|------|------|
| **사진 쪽 누르고 스크롤 시 캔버스는 안 움직이고 사진만 이동** | 터치 시 `_resolveGestureTargetFromPoint`에서 미디어 위면 무조건 선택+리사이즈 모드로 전환하고 `_gestureTarget = media`로 설정해, 짧게 누르고 드래그만 해도 사진이 이동함. |
| **탭 제거 후 선택이 아예 안 됨** | 0.5초 롱프레스만 선택으로 바꾼 뒤, **캔버스**가 롱프레스를 먼저 받아서 미디어 위일 때 아무 동작 없이 `return`만 하고, MediaWidget에는 롱프레스가 전달되지 않음. |
| **메뉴 바 레이아웃 깨짐** | 액션 바 높이 부족, 버튼/텍스트 overflow, 뷰포트 밖으로 나갈 때 위치 미처리로 인한 잘림·깨짐. |
| **메뉴 바가 사진 회전 시 함께 회전·이동** | 메뉴 위치를 미디어 로컬 좌표 `(w/2, h/2 + 2*h)` 등으로 계산해 회전 변환이 적용된 뷰 좌표를 사용함. |
| **메뉴 바가 사진과 너무 멀리 떨어져 있음** | 이격을 이미지 높이 100% 또는 200%로 두어 거리만 큼. |

---

## 3. 조치사항

### 3.1 캔버스 이동 vs 사진 이동 구분
- **`_resolveGestureTargetFromPoint`**
  - 미디어 위 터치여도 **이미 선택된 미디어(크기 조정 모드)** 위일 때만 `_gestureTarget = media`로 설정.
  - **선택되지 않은 미디어** 위면 `_gestureTarget = canvas`로 두어, 드래그 시 **캔버스만 팬**되도록 수정.
- **`_onTapUp`**
  - 미디어 위 **탭**으로는 선택하지 않음 (해당 분기에서 `return`만 수행).
- **MediaWidget `onTap`**
  - 탭으로 선택하지 않고, **이미 선택된 상태에서만** 탭 시 메뉴 표시.

### 3.2 0.5초 롱프레스로 선택 복구
- **`_onCanvasLongPress`**
  - 미디어 위 롱프레스 시 다시 **`selectMedia` + `enterMediaResizeMode`** 호출하도록 복구.
  - 캔버스가 롱프레스를 먼저 받으므로, 여기서 처리해야 선택이 동작함.

### 3.3 메뉴 바 레이아웃·위치
- **높이** 52, **고정 width**로 Row 배치, **뷰포트 클램프**로 `barLeft`를 화면 안으로 제한.
- 텍스트 **overflow: ellipsis**, **maxLines: 1**, 라벨 간소화(앞으로→앞, 뒤로→뒤).
- **위치 계산**
  - 미디어 4꼭짓점을 뷰 좌표로 변환 후 **최하단 Y** = `bottomView`.
  - **이격** = 이미지 높이 **50%** (`gap = h * 0.5`).
  - **메뉴 바 top** = `bottomView + gap` → **회전과 무관하게 항상 화면 기준 아래쪽 고정**.
  - 가로는 미디어 중심 X(`mediaCenterInView.dx`) 기준으로 배치.

### 3.4 반전·회전 핸들 유지
- 회전 핸들(위쪽 중앙), 상/하 반전(왼쪽 1/5), 좌/우 반전(아래 1/5)을 **다시 표시**.
- 회전용 상태 변수 `_rotateOverlayStartAngleRad`, `_rotateOverlayStartMediaDegrees`, `_rotationHandleOffset` 및 `centerGlobal` 사용 복구.

---

## 4. 수정·추가된 파일 목록

| 파일 | 변경 요약 |
|------|------------|
| `lib/widgets/canvas/drawing_canvas.dart` | 반전/회전 핸들 위치·원형, 탭/롱프레스/캔버스 롱프레스 선택 로직, _resolveGestureTargetFromPoint(선택된 미디어만 media 타겟), 메뉴 바(하단 고정·이격 50%·복사/삭제/앞/뒤/자르기), 회전·반전 핸들 재추가 |
| `lib/widgets/canvas/media_widget.dart` | (이전 작업) onTapDown/onTapUp/onTapCancel 옵션 추가 (현재 미사용) |
| `lib/screens/canvas/canvas_controller.dart` | duplicateMedia(mediaId) 추가 |

---

## 5. 최종 동작 정리

| 동작 | 결과 |
|------|------|
| 사진 **짧게 누르고 드래그** | 선택되지 않음 → **캔버스만 스크롤**. |
| 사진 **0.5초 롱프레스** | 해당 사진 **선택 + 크기 조정 모드**(핸들·메뉴 바 표시). |
| **선택된 사진** 드래그 | **사진만 이동**. |
| **선택된 사진** 탭 | 삭제·레이어 등 **메뉴**(기존 _showMediaOptions) 표시. |
| 선택 시 **메뉴 바** | 사진 하단(화면 기준 아래 고정, 높이 50% 이격)에 **복사, 삭제, 앞, 뒤, 자르기**. |
| **회전·반전 핸들** | 위/좌/하 1/5 위치 원형 핸들로 유지. |

---

*보고서 작성일: 2026년 2월 10일*
