# [017] 추가 기능: 태그 UI 및 태그 영역 하이라이트

## 요청 정보

- **날짜:** 2026-01-29
- **요청 내용:** 개발 순서 미체크(선택) 항목 진행
  - **11.1** 손글씨: 영역 선택 후 @친구 태그 (TODO: UI)
  - **11.1** 사진/영상: 첨부 후 @친구 태그 (TODO: UI) — 메뉴는 있으나 미구현 메서드 오류 해결
  - **11.3** 태그 영역 하이라이트 (TODO)

---

## 진행 내용

### 1. 손글씨: 영역 선택 후 @친구 태그

- **동작 흐름**
  1. 캔버스에서 태그할 **손글씨 위를 길게 누름** (롱프레스).
  2. 해당 위치의 스트로크를 감지하여 **바텀 시트 메뉴** 표시.
  3. 「@친구 태그」 탭 → **친구 선택 피커** 표시.
  4. 친구 선택 시 `TagModel` 생성 (targetType: stroke, targetId: 스트로크 ID, areaX/Y/Width/Height: 스트로크 영역).

- **구현 요약**
  - `DrawingCanvas`: `GestureDetector`에 `onLongPressStart` / `onLongPress` / `onLongPressEnd` 추가.
  - `_getStrokeAtPoint(Offset canvasPoint)`: 서버 스트로크·로컬 스트로크 역순으로 히트 테스트(반경 24px), hit 시 `(strokeId, areaX, areaY, areaWidth, areaHeight)` 반환.
  - `_strokeBounds(Iterable<Offset>)`: 포인트 min/max로 영역 계산.
  - `_showTagStrokeFriendPicker(context, strokeId, areaX, areaY, areaWidth, areaHeight)`: 친구 목록 바텀 시트, 선택 시 `TagService.createTag(TagModel(..., targetType: stroke, area*))` 호출.

- **참고**
  - 로컬 스트로크는 `firestoreId ?? id` 사용 (저장 전 태그 시 클라이언트 ID로 태그).

### 2. 사진/영상: 첨부 후 @친구 태그 (오류 해결)

- **문제**
  - 미디어 롱프레스 옵션 메뉴에 「@친구 태그」 항목은 있었으나, `_showTagFriendPicker(context, media)` 호출만 있고 **메서드 미정의**로 컴파일 오류 발생.

- **조치**
  - `_showTagFriendPicker(BuildContext context, MediaModel media)` 구현.
  - `FriendProvider`·`AuthProvider`·`TagService`로 친구 목록 표시, 선택 시 `TagModel` 생성 (targetType: image / video / text by media.type, targetId: media.id).
  - `AuthProvider.currentUser` → `auth.user` 수정 (실제 getter명 반영).
  - 중복 import `media_model.dart` 제거.

### 3. 태그 영역 하이라이트

- **동작**
  - **모아보기(태그함)** 에서 태그 카드를 탭해 원본 캔버스로 점프할 때, 해당 태그의 **손글씨 영역**을 금색 테두리·연한 채움으로 하이라이트.
  - 하이라이트는 **3초 후 자동 해제**.

- **구현 요약**
  - **tags_tab.dart**  
    `_jumpToOriginal(TagModel tag)`에서 `tag.areaX/Y/Width/Height`가 모두 있을 때 `Rect.fromLTWH(...)`로 `highlightTagArea` 생성 후 `CanvasScreen(highlightTagArea: ...)`에 전달.
  - **canvas_screen.dart**  
    `CanvasScreen`에 `highlightTagArea` 파라미터 추가. 상태 `_highlightTagArea`에 보관 후 `DrawingCanvas`에 전달. 진입 시 `Future.delayed(3초)`로 `_highlightTagArea = null` 설정.
  - **drawing_canvas.dart**  
    `DrawingCanvas`에 `highlightTagArea` (Rect?, 캔버스 좌표) 추가. `_CanvasPainter`에 `highlightTagRect` 전달.
  - **_CanvasPainter**  
    `highlightTagRect != null`일 때 캔버스 좌표계에서:
    - 채우기: `AppColors.gold` 12% 투명도.
    - 테두리: `AppColors.gold`, 두께 2.5, 모서리 반경 4, 영역 4px 확장한 RRect로 그리기.

- **참고**
  - 이미지/영상 등 영역(area*)이 없는 태그는 `highlightTagArea == null`이라 하이라이트 없이 점프만 수행.

---

## 결과

| 항목 | 상태 |
|------|------|
| 11.1 손글씨 @친구 태그 UI | 완료 |
| 11.1 사진/영상 @친구 태그 (오류 해결) | 완료 |
| 11.3 태그 영역 하이라이트 | 완료 |

- `잉크_앱프로젝트_정보/개발_순서.md` 해당 항목 모두 체크 반영.

---

## 변경된 파일

| 구분 | 경로 |
|------|------|
| 수정 | `ink_talk/lib/widgets/canvas/drawing_canvas.dart` |
| 수정 | `ink_talk/lib/screens/canvas/canvas_screen.dart` |
| 수정 | `ink_talk/lib/screens/home/tabs/tags_tab.dart` |
| 수정 | `잉크_앱프로젝트_정보/개발_순서.md` |

---

## 테스트 방법

1. **손글씨 @친구 태그**
   - 캔버스에서 손글씨를 그린 뒤, 해당 스트로크 위를 **길게 누름** → 「@친구 태그」 → 친구 선택 → 스낵바 확인. 모아보기 탭에서 해당 태그 카드 노출 여부 확인.
2. **사진/영상 @친구 태그**
   - 캔버스에 사진 또는 영상 첨부 후, 해당 미디어 **길게 누름** → 투명도 등 메뉴에서 「@친구 태그」 → 친구 선택 → 태그 생성·모아보기 반영 확인.
3. **태그 영역 하이라이트**
   - 모아보기에서 **영역 정보가 있는 태그**(손글씨 태그) 카드를 탭 → 해당 채팅방 캔버스로 이동 후, 금색 하이라이트가 약 3초간 표시되는지 확인.

---

## 알려진 제한사항 / TODO

- 손글씨 태그: **다중 스트로크 영역 선택**(라쏘/사각 선택 후 일괄 태그)은 미구현. 현재는 한 스트로크 단위만 태그 가능.
- 태그 하이라이트: 이미지/영상/텍스트 태그는 영역 필드가 없어 하이라이트 미적용.

---

## 참고 문서

- `잉크_앱프로젝트_정보/개발_순서.md` Phase 11 (모아보기·태그함)
- `ink_talk/lib/models/tag_model.dart` (TagModel, TagTargetType, area 필드)
