# [004] Phase 4 채팅 목록 (퍼즐 카드 UI)

## 요청 정보

- **날짜:** 2026-01-29
- **요청 내용:** 개발 순서 Phase 4 진행
  - 4.1 채팅 목록 화면 (퍼즐 카드 UI)
  - 4.2 채팅방 생성 (1:1 / 그룹)
  - 4.3 채팅방 설정 (역할/권한)

---

## 진행 내용

### 4.1 채팅 목록 화면

#### RoomService 생성
- 채팅방 목록 실시간 스트림 (`getRoomsStream`)
- 채팅방 단일/스트림 조회
- 마지막 이벤트 업데이트
- 읽음 처리

#### RoomProvider 생성
- 채팅방 목록 상태 관리
- 멤버 사용자 정보 캐싱
- 채팅방 선택 관리
- 채팅방 이름/이미지 표시 헬퍼

#### PuzzleCard 위젯
```
┌─────────────────────────────────────┐
│ [프로필]  채팅방 이름    3명   오전 10:30 │
│ [퍼즐]    마지막 메시지...       (2)   │
└─────────────────────────────────────┘
```

- 프로필 이미지 + 퍼즐 타일 (손글씨 미리보기)
- 방 이름 / 멤버 수
- 마지막 이벤트 아이콘 + 미리보기
- 시간 포맷 (오늘/어제/요일/날짜)
- 미확인 배지 (99+)

#### ChatTab UI 업데이트
- 채팅방 목록 (PuzzleCard)
- 빈 상태 표시
- 새로고침

---

### 4.2 채팅방 생성

#### 1:1 채팅 (`createOrGetDirectRoom`)
```
1. 기존 1:1 채팅방 확인
2. 없으면 새로 생성 (양쪽 모두 owner)
3. 있으면 기존 방 반환
```

#### 그룹 채팅 (`createGroupRoom`)
```
1. 그룹 이름 필수 입력
2. 친구 다중 선택
3. Owner + 선택된 멤버로 생성
```

#### CreateChatScreen
- 친구 선택 화면
- 1:1: 친구 탭 → 바로 채팅 생성
- 그룹: 체크박스 선택 + 그룹 이름 입력
- 선택된 친구 칩 표시

---

### 4.3 채팅방 설정

#### 역할 (MemberRole)
| 역할 | 설명 |
|------|------|
| **owner** | 방장 – 모든 권한 |
| **admin** | 관리자 – 멤버 초대/관리 |
| **member** | 멤버 – 일반 참여 |
| **viewer** | 보기 전용 – 읽기만 가능 |

#### 채팅방 옵션 (롱프레스)
- 채팅방 열기
- 알림 설정
- 멤버 초대 (admin 이상)
- 채팅방 설정 (owner만)
- 나가기/삭제

#### 역할 관리
- 멤버 목록 + 현재 역할
- 역할 변경 (owner만)

---

## 결과

| 항목 | 상태 |
|------|------|
| 퍼즐 카드 UI | ✅ 완료 |
| 탭/롱프레스 인터랙션 | ✅ 완료 |
| 1:1 채팅 생성 | ✅ 완료 |
| 그룹 채팅 생성 | ✅ 완료 |
| 역할 관리 | ✅ 완료 |

---

## 변경된 파일

### 신규 생성

- `lib/services/room_service.dart` – 채팅방 서비스
- `lib/providers/room_provider.dart` – 채팅방 상태 관리
- `lib/widgets/chat/puzzle_card.dart` – 퍼즐 카드 위젯
- `lib/screens/chat/create_chat_screen.dart` – 채팅 생성 화면

### 수정

- `lib/main.dart` – RoomProvider 추가
- `lib/screens/home/tabs/chat_tab.dart` – 전체 UI 재구현

### 문서 업데이트

- `잉크_앱프로젝트_정보/개발_순서.md` – Phase 4 체크 완료

---

## 관련 커밋

- **커밋 해시:** `40f6756`
- **커밋 메시지:** Phase 4 완료: 채팅 목록 (퍼즐 카드 UI)

---

## 테스트 방법

```bash
cd /Users/ojaebaek/ink/ink_talk
flutter run
```

### 채팅 목록 테스트
1. 로그인 후 채팅 탭 이동
2. 채팅방이 없으면 빈 상태 표시
3. 채팅방이 있으면 퍼즐 카드 목록 표시

### 1:1 채팅 생성 테스트
1. + 버튼 → "1:1 채팅"
2. 친구 선택
3. 채팅방 생성 확인

### 그룹 채팅 생성 테스트
1. + 버튼 → "그룹 채팅"
2. 친구 다중 선택
3. 그룹 이름 입력
4. "만들기" 버튼
5. 채팅방 생성 확인

### 채팅방 옵션 테스트
1. 채팅방 카드 롱프레스
2. 옵션 시트 확인
3. 역할에 따른 옵션 표시 확인

---

## 기술 선택 이유

| 기술 | 선택 이유 |
|------|-----------|
| **퍼즐 카드** | 디자인 명세서 기반 – 손글씨 미리보기 강조 |
| **1:1 채팅 중복 방지** | 같은 친구와 여러 채팅방 생성 방지 |
| **역할 기반 권한** | 그룹 채팅 관리 유연성 |

---

## 개발 중 발생한 오류 및 대처

### 오류 1: unused_import 경고

**증상:**
```
Unused import: '../../models/room_model.dart'
```

**원인:**
- CreateChatScreen에서 RoomModel 직접 사용하지 않음

**해결:**
- 불필요한 import 제거

---

### 오류 2: unused_local_variable 경고

**증상:**
```
The value of the local variable 'authProvider' isn't used
```

**원인:**
- _showRoomOptionsSheet에서 authProvider 선언만 하고 사용하지 않음

**해결:**
- 불필요한 변수 선언 제거

---

## 알려진 제한사항 / TODO

- [ ] 초대 링크 생성 (선택 기능)
- [ ] 세부 권한 설정 (도형 수정, 내보내기 등)
- [ ] 채팅방 검색
- [ ] 채팅방 고정
- [ ] 채팅방 알림 설정 저장
- [ ] 실제 채팅방 화면 (Phase 5)

---

## 참고 문서

- `잉크_앱프로젝트_정보/INK_최종_기능_명세서_v1.0.md` (3장 채팅/단톡)
- `잉크_앱프로젝트_정보/INK_디자인_명세서_v1.0.md` (4장 퍼즐 카드 UI)
- `잉크_앱프로젝트_정보/개발_순서.md`

---

## 다음 단계

| Phase | 내용 |
|-------|------|
| **5.1** | 채팅방 화면 – 캔버스 기본 구조 |
| **5.2** | 상단 바 (방 정보, 검색, 자료) |
| **5.3** | 펜 툴바 |
