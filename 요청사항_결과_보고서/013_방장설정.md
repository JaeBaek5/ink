# [013] Phase 12.3 방장 설정

## 요청 정보

- **날짜:** 2026-01-29
- **요청 내용:** 개발 순서 Phase 12.3 방장 설정 진행
  - 내보내기 허용/차단 (RoomModel 확장)
  - 워터마크 강제
  - 로그 공개/비공개

---

## 진행 내용

### 1. RoomModel 확장

| 필드 | 타입 | 기본값 | 설명 |
|------|------|--------|------|
| `exportAllowed` | bool | true | 멤버의 캔버스 내보내기 허용 여부 |
| `watermarkForced` | bool | false | 내보내기 시 워터마크 필수 여부 |
| `logPublic` | bool | true | 시간순 로그(타임라인) 공개 여부 |

- `fromFirestore` / `toFirestore`에 위 필드 반영 (기존 방 문서는 null 시 기본값 적용).
- `copyWithHostSettings()` 추가 (선택적 사용).

### 2. RoomService / RoomProvider

- `updateRoom(roomId, { name, imageUrl, exportAllowed, watermarkForced, logPublic })` 확장.
- 새 방 생성 시 `exportAllowed: true`, `watermarkForced: false`, `logPublic: true` 저장.
- RoomProvider에 `getRoomStream(roomId)` 노출 (단일 방 실시간 스트림).

### 3. 내보내기 허용/차단

- **채팅 목록** · **캔버스** 방장 설정에서 "내보내기 허용" 스위치로 on/off.
- **캔버스**에서 내보내기 메뉴 탭 시: `room.exportAllowed == false`이면 내보내기 다이얼로그를 열지 않고, 스낵바로 "방장이 내보내기를 제한했습니다." 표시.

### 4. 워터마크 강제

- 방장 설정에서 "워터마크 강제" on 시, 해당 방의 내보내기에서는 항상 워터마크 포함.
- 내보내기 다이얼로그:
  - 워터마크 강제 시: 체크박스 비활성화, 부제목에 "방장이 워터마크를 필수로 설정했습니다" 표시.
- 내보내기 실행 시 `useWatermark = room.watermarkForced || includeWatermark`로 적용.

### 5. 로그 공개/비공개

- 방장 설정에서 "로그 공개" off 시, 해당 방의 **시간순 네비게이션(타임라인)**을 멤버에게 숨김.
- `TimelineNavigator`에 `logPublic` 파라미터 추가.
  - `logPublic == false`: 이벤트 목록 대신 "로그 비공개" 문구만 표시 (세로 회전 텍스트).
- `DrawingCanvas`에 `logPublic` 전달, 캔버스 화면에서는 `widget.room.logPublic` 전달.

### 6. 방장 설정 UI

- **채팅 탭**  
  채팅방 길게 눌러 "채팅방 설정" → 시트에 **방장 설정** 섹션 추가 (owner/admin만 표시).
  - 내보내기 허용 / 워터마크 강제 / 로그 공개 스위치 3개 + 저장 버튼.
- **캔버스**  
  메뉴 → "채팅방 설정" 탭 시 `showRoomHostSettingsSheet(context, room)` 호출.
  - 방장(owner/admin)만 시트 표시·저장 가능.
  - 비방장이 탭하면 스낵바: "방장만 설정을 변경할 수 있습니다."

---

## 결과

- [x] RoomModel에 `exportAllowed`, `watermarkForced`, `logPublic` 추가 및 Firestore 연동
- [x] 내보내기 허용/차단: 방장 설정 토글 + 캔버스 내보내기 메뉴에서 차단 시 스낵바
- [x] 워터마크 강제: 방장 설정 토글 + 내보내기 다이얼로그에서 강제 시 체크 비활성화 및 문구 표시, 내보내기 시 항상 워터마크 적용
- [x] 로그 공개/비공개: 방장 설정 토글 + 타임라인 비공개 시 "로그 비공개" 표시
- [x] 채팅 탭 채팅방 설정 시트에 방장 설정 섹션 추가 (owner/admin만)
- [x] 캔버스에서 "채팅방 설정"으로 방장 설정 시트 호출 (공통 위젯)

---

## 변경된 파일

| 구분 | 경로 |
|------|------|
| 수정 | `ink_talk/lib/models/room_model.dart` |
| 수정 | `ink_talk/lib/services/room_service.dart` |
| 수정 | `ink_talk/lib/providers/room_provider.dart` |
| 수정 | `ink_talk/lib/screens/home/tabs/chat_tab.dart` |
| 수정 | `ink_talk/lib/screens/canvas/canvas_screen.dart` |
| 수정 | `ink_talk/lib/widgets/canvas/drawing_canvas.dart` |
| 수정 | `ink_talk/lib/widgets/canvas/timeline_navigator.dart` |
| 신규 | `ink_talk/lib/widgets/room/room_host_settings_sheet.dart` |
| 수정 | `잉크_앱프로젝트_정보/개발_순서.md` |

---

## 테스트 방법

1. **방장 설정 진입**
   - 채팅 탭에서 그룹 방 길게 눌러 "채팅방 설정" → 방장 설정 섹션(스위치 3개) 확인.
   - 캔버스 진입 후 메뉴 → "채팅방 설정" → 방장일 때만 동일 설정 시트 표시.
2. **내보내기 허용/차단**
   - 방장 설정에서 "내보내기 허용" off → 저장 후 다른 멤버(또는 동일 계정)로 캔버스에서 "내보내기" 탭 → "방장이 내보내기를 제한했습니다." 스낵바 확인.
3. **워터마크 강제**
   - "워터마크 강제" on → 저장 후 내보내기 다이얼로그에서 워터마크 체크 비활성화 및 안내 문구 확인.
4. **로그 공개/비공개**
   - "로그 공개" off → 저장 후 해당 방 캔버스에서 우측 타임라인에 "로그 비공개"만 보이는지 확인.

---

## 알려진 제한사항 / TODO

- 캔버스 화면은 진입 시점의 `widget.room`을 사용. 방장이 설정을 변경해도 **캔버스에 머무른 상태에서는** 로그 공개/비공개·내보내기 허용 등이 즉시 반영되지 않을 수 있음. 방을 나갔다가 다시 들어오면 최신 설정 적용.
- 워터마크 실제 이미지 합성은 `ExportService._addWatermark()`에서 아직 원본 반환(추후 이미지 오버레이 구현 가능).

---

## 참고 문서

- `잉크_앱프로젝트_정보/개발_순서.md` Phase 12.3
- `요청사항_결과_보고서/012_공유내보내기.md`

---

## 다음 단계

- Phase 13: 설정 (프로필 편집, 알림, 캔버스 확장 방식, 캐시, 계정 관리)
