# [014] Phase 13 설정

## 요청 정보

- **날짜:** 2026-01-29
- **요청 내용:** 개발 순서 Phase 13 설정 진행
  - 프로필 편집
  - 알림 설정
  - 캔버스 확장 방식 설정
  - 캐시 관리
  - 계정 관리 (로그아웃/탈퇴)

---

## 진행 내용

### 1. 프로필 편집

- **화면:** `ProfileEditScreen` (설정 탭 → 프로필 영역 연필 아이콘)
- **기능:** 이름(displayName), 표시 ID(visibleId), 상태 메시지(statusMessage) 편집
- **저장:** `UserService.updateProfile()` → Firestore 사용자 문서 업데이트
- **표시 이름 동기화:** Firestore 저장 후 `Firebase Auth updateDisplayName()` 호출로 앱 내 표시 이름 즉시 반영
- 프로필 사진은 Google 계정에서만 변경 가능하다는 안내 문구 표시

### 2. 알림 설정

- **화면:** `NotificationSettingsScreen` (설정 → 알림 설정)
- **저장소:** `SharedPreferences` (SettingsService)
- **항목:**
  - 알림 사용 (기본 on)
  - 알림 소리 (기본 on)
- 실제 푸시 알림 발송은 미구현(저장만). 추후 FCM 연동 시 이 설정값 사용

### 3. 캔버스 확장 방식 설정

- **화면:** `CanvasExpandScreen` (설정 → 캔버스 확장 방식)
- **옵션:** `CanvasExpandMode` enum
  - `rectangular`: 사각 확장 (캔버스를 사각형 영역 단위로 확장)
  - `free`: 자유 확장 (무한 캔버스)
- **저장소:** SharedPreferences (`canvas_expand_mode`)
- 설정 탭 목록에 현재 선택값(사각 확장/자유 확장) 표시
- 캔버스 동작에 아직 반영되지 않음(선택값 저장만, 추후 캔버스 로직에서 사용 예정)

### 4. 캐시 관리

- **화면:** `CacheScreen` (설정 → 캐시 관리)
- **표시:** `getTemporaryDirectory()` 기준 임시 디렉터리 용량 계산 후 표시 (B/KB/MB)
- **캐시 삭제:** 확인 다이얼로그 후 임시 디렉터리 내 파일/폴더 삭제
- Firestore 로컬 캐시는 별도 API 필요로 미포함

### 5. 계정 관리

- **로그아웃:** 기존 유지. 확인 다이얼로그 후 `AuthProvider.signOut()` 호출
- **계정 탈퇴:** 신규 구현
  - 설정 → 계정 탈퇴 (경고 문구: 데이터 삭제·복구 불가)
  - 1차 확인 다이얼로그 후 `AuthProvider.deleteAccount()` 호출
  - **순서:** Firestore `users/{uid}` 문서 삭제 → Firebase Auth 계정 삭제(재인증 후)
  - Google 로그인 사용자: `signInSilently()` 또는 `signIn()`으로 재인증 후 `user.delete()`, 로그아웃

### 6. 공통·인프라

- **SettingsService** (`lib/services/settings_service.dart`): SharedPreferences 기반 로컬 설정
  - 알림 on/off, 알림 소리 on/off, 캔버스 확장 방식
- **의존성:** `shared_preferences: ^2.3.3` 추가
- 설정 탭을 **StatefulWidget**으로 변경하여 캔버스 확장 방식 현재값 로드·표시

---

## 결과

- [x] 프로필 편집 (이름, 표시 ID, 상태 메시지, Firestore + Auth 표시 이름 반영)
- [x] 알림 설정 (알림 사용/소리 토글, SharedPreferences 저장)
- [x] 캔버스 확장 방식 설정 (사각/자유 선택, SharedPreferences 저장)
- [x] 캐시 관리 (용량 표시, 임시 디렉터리 삭제)
- [x] 계정 관리 (로그아웃 유지, 계정 탈퇴: Firestore 문서 삭제 + Auth 삭제·재인증)

---

## 변경된 파일

| 구분 | 경로 |
|------|------|
| 수정 | `ink_talk/pubspec.yaml` (shared_preferences 추가) |
| 신규 | `ink_talk/lib/services/settings_service.dart` |
| 신규 | `ink_talk/lib/screens/settings/profile_edit_screen.dart` |
| 신규 | `ink_talk/lib/screens/settings/notification_settings_screen.dart` |
| 신규 | `ink_talk/lib/screens/settings/canvas_expand_screen.dart` |
| 신규 | `ink_talk/lib/screens/settings/cache_screen.dart` |
| 수정 | `ink_talk/lib/services/user_service.dart` (deleteUserDocument, updateProfile에서 Auth displayName 반영) |
| 수정 | `ink_talk/lib/services/auth_service.dart` (deleteAccount 재인증·삭제) |
| 수정 | `ink_talk/lib/providers/auth_provider.dart` (deleteAccount) |
| 수정 | `ink_talk/lib/screens/home/tabs/settings_tab.dart` (모든 설정 메뉴 연동, 탈퇴) |
| 수정 | `잉크_앱프로젝트_정보/개발_순서.md` (Phase 13 체크) |

---

## 테스트 방법

1. **프로필 편집:** 설정 → 프로필 연필 아이콘 → 이름/표시 ID/상태 메시지 수정 → 저장 → 설정 탭에서 이름 반영 확인
2. **알림 설정:** 설정 → 알림 설정 → 토글 변경 후 재진입 시 값 유지 확인
3. **캔버스 확장 방식:** 설정 → 캔버스 확장 방식 → 사각/자유 선택 → 설정 탭에 현재값 표시 확인
4. **캐시 관리:** 설정 → 캐시 관리 → 용량 표시 확인 → 캐시 삭제 → 확인 후 용량 0 B 근처로 변경 확인
5. **로그아웃:** 설정 → 로그아웃 → 확인 → 로그인 화면으로 이동 확인
6. **계정 탈퇴:** (테스트 계정 권장) 설정 → 계정 탈퇴 → 확인 → 재인증 후 계정 삭제 및 로그인 화면 이동 확인

---

## 알려진 제한사항 / TODO

- 테마(다크 모드 등)는 "시스템 설정" 안내만 있고 실제 전환 미구현
- 기본 펜 설정 메뉴는 미연동(TODO)
- 알림 설정은 값만 저장하며, FCM 등 실제 푸시 발송 미연동
- 캔버스 확장 방식은 저장만 되며, 캔버스 동작에는 아직 미적용
- 탈퇴 시 Firestore 내 해당 사용자 관련 데이터(친구, 채팅방 등) 정리 정책은 추후 확장 가능

---

## 참고 문서

- `잉크_앱프로젝트_정보/개발_순서.md` Phase 13

---

## 다음 단계

- Phase 14: 성능 최적화
