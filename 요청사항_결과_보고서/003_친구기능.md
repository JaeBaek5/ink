# [003] Phase 3 친구 기능

## 요청 정보

- **날짜:** 2026-01-29
- **요청 내용:** 개발 순서 Phase 3 (친구 기능) 진행
  - 3.1 친구 목록 화면 UI, Firestore 조회
  - 3.2 친구 추가 (ID/전화번호)
  - 3.3 친구 관리 (삭제/차단)

---

## 진행 내용

### 3.1 친구 목록

#### FriendService 생성
- 친구 목록 실시간 스트림 (`getFriendsStream`)
- 받은 친구 요청 스트림 (`getPendingRequestsStream`)
- 차단 목록 스트림 (`getBlockedUsersStream`)
- 친구 사용자 정보 조회 (`getFriendUserInfo`)

#### FriendProvider 생성
- 친구 목록 상태 관리
- 친구 사용자 정보 캐싱 (`_friendUserCache`)
- 실시간 스트림 구독/해제

#### FriendsTab UI 업데이트
- 내 프로필 섹션 (로그인 사용자 정보 표시)
- 받은 친구 요청 섹션
- 친구 목록 (빈 상태 / 목록)
- 친구 타일 (프로필 이미지, 이름, 상태 메시지)
- 롱프레스 시 옵션 메뉴

---

### 3.2 친구 추가

#### ID로 추가 (`addFriendById`)
```
1. visibleId로 사용자 검색
2. 자기 자신 / 이미 친구 / 차단 확인
3. 양방향 친구 관계 생성 (batch)
```

#### 전화번호로 추가 (`addFriendByPhone`)
```
1. 전화번호 정규화 (한국 번호 처리)
2. phoneNumber로 사용자 검색
3. ID로 추가와 동일 로직
```

#### 연락처 동기화 (추가)
```
1. 연락처 권한 요청 (Android/iOS)
2. 연락처에서 전화번호 추출 및 정규화
3. Firestore에서 INK 가입자 조회 (30개씩 분할)
4. 이미 친구인 사용자 제외
5. 다중 선택 후 일괄 추가
```

#### UI
- 친구 추가 바텀 시트 (ID/전화번호/연락처 선택)
- ID 입력 다이얼로그
- 전화번호 입력 다이얼로그
- **연락처 동기화 화면** (ContactSyncScreen)
  - 권한 요청 UI
  - 추천 친구 목록 (체크박스)
  - 전체 선택/해제
  - 일괄 친구 추가
- 로딩 상태 / 에러 메시지 표시

---

### 3.3 친구 관리

#### 친구 삭제 (`removeFriend`)
- 양방향 친구 관계 삭제 (batch)

#### 친구 차단 (`blockFriend`)
- 내 친구 상태를 `blocked`로 변경
- 상대방 친구 목록에서 삭제

#### 차단 해제 (`unblockFriend`)
- 차단 관계 삭제

#### UI
- 친구 롱프레스 → 옵션 바텀 시트
- 채팅하기 / 별명 설정 / 친구 삭제 / 차단
- 삭제/차단 전 확인 다이얼로그

---

## 결과

| 항목 | 상태 |
|------|------|
| 친구 목록 화면 UI | ✅ 완료 |
| Firestore 친구 조회 | ✅ 완료 |
| ID로 친구 추가 | ✅ 완료 |
| 전화번호로 친구 추가 | ✅ 완료 |
| 친구 삭제 | ✅ 완료 |
| 친구 차단 | ✅ 완료 |

---

## 변경된 파일

### 신규 생성

- `lib/services/friend_service.dart` – 친구 서비스 (Firestore CRUD)
- `lib/services/contact_service.dart` – 연락처 동기화 서비스
- `lib/providers/friend_provider.dart` – 친구 상태 관리
- `lib/screens/friends/contact_sync_screen.dart` – 연락처 친구 찾기 화면

### 수정

- `lib/main.dart` – FriendProvider 추가
- `lib/screens/home/tabs/friends_tab.dart` – 전체 UI 재구현, 연락처 동기화 연결
- `lib/models/user_model.dart` – phoneNumber 필드 추가
- `pubspec.yaml` – flutter_contacts, permission_handler 추가
- `android/app/src/main/AndroidManifest.xml` – READ_CONTACTS 권한
- `ios/Runner/Info.plist` – NSContactsUsageDescription 추가

### 문서 업데이트

- `잉크_앱프로젝트_정보/개발_순서.md` – Phase 3 체크 완료

---

## 관련 커밋

- **커밋 해시:** `b2f1154`
- **커밋 메시지:** Phase 3 완료: 친구 기능 (목록/추가/삭제/차단)

---

## 테스트 방법

```bash
cd /Users/ojaebaek/ink/ink_talk
flutter run
```

### 친구 추가 테스트
1. 로그인 후 친구 탭 이동
2. 우측 상단 + 버튼 클릭
3. "ID로 추가" 선택
4. 다른 사용자의 visibleId 입력 (예: ink_xxxxxxxx)
5. 추가 버튼 클릭 → 성공 스낵바 확인

### 친구 목록 테스트
1. 친구 추가 후 목록에 표시되는지 확인
2. 프로필 이미지, 이름, 상태 메시지 표시 확인

### 친구 삭제/차단 테스트
1. 친구 타일 롱프레스
2. 옵션 시트에서 "친구 삭제" 또는 "차단" 선택
3. 확인 다이얼로그 → 확인
4. 목록에서 제거 확인

---

## 기술 선택 이유

| 기술 | 선택 이유 |
|------|-----------|
| **양방향 친구 관계** | 카카오톡 스타일 – 친구 추가 시 상대방도 자동 추가 |
| **Firestore Batch** | 다중 문서 원자적 쓰기 보장 |
| **실시간 스트림** | 친구 목록 변경 시 즉시 UI 반영 |
| **친구 정보 캐싱** | 불필요한 Firestore 조회 최소화 |

---

## 개발 중 발생한 오류 및 대처

### 오류 1: unused_local_variable 경고

**증상:**
```
warning • The value of the local variable 'friendProvider' isn't used
```

**원인:**
- `_showSearchDialog`에서 선언한 변수를 사용하지 않음

**해결:**
- 사용하지 않는 변수 선언 제거

---

### 오류 2: prefer_final_fields 경고

**증상:**
```
info • The private field _friendUserCache could be 'final'
```

**원인:**
- `Map<String, UserModel> _friendUserCache = {}`가 재할당되지 않음

**해결:**
```dart
// 변경 전
Map<String, UserModel> _friendUserCache = {};

// 변경 후
final Map<String, UserModel> _friendUserCache = {};
```

---

## 알려진 제한사항 / TODO

- [x] 연락처 동기화 기반 친구 추천 (선택 기능) - 추가 완료
- [ ] 친구 검색 (실시간 필터링)
- [ ] 친구 별명 설정 기능
- [ ] 친구 요청 수락/거절 UI
- [ ] 차단 목록 관리 화면

---

## 참고 문서

- `잉크_앱프로젝트_정보/INK_최종_기능_명세서_v1.0.md` (2장 친구 기능)
- `잉크_앱프로젝트_정보/개발_순서.md`

---

## 다음 단계

| Phase | 내용 |
|-------|------|
| **4.1** | 채팅 목록 화면 – 퍼즐 카드 UI |
| **4.2** | 채팅방 생성 (1:1 / 그룹) |
| **4.3** | 채팅방 설정 및 역할/권한 |
