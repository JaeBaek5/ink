# [008] Phase 8 도형/선

## 요청 정보

- **날짜:** 2026-01-29
- **요청 내용:** 개발 순서 Phase 8 (도형/선) 진행
  - 8.1 도형 종류
  - 8.2 도형 스타일
  - 8.3 도형 편집
  - 8.4 도형 수정 권한

---

## 진행 내용

### 8.1 도형 종류

| 도형 | 아이콘 | 설명 |
|------|--------|------|
| 선 | ─ | 시작점에서 끝점 직선 |
| 화살표 | → | 끝점에 화살표 머리 |
| 사각형 | □ | 시작점-끝점 기준 사각형 |
| 원/타원 | ○ | 시작점-끝점 기준 타원 |

---

### 8.2 도형 스타일

```dart
// ShapeModel 스타일 필드
strokeColor: '#000000',   // 선 색상 (hex)
strokeWidth: 2.0,         // 선 굵기
fillColor: '#FF0000',     // 채우기 색상 (null = 투명)
fillOpacity: 1.0,         // 채우기 투명도
lineStyle: LineStyle.solid, // 실선/점선/점점선
```

#### LineStyle enum
- `solid` - 실선
- `dashed` - 점선
- `dotted` - 점점선

---

### 8.3 도형 편집

#### 선택/이동
- 도형 선택 시 골드 테두리 + 핸들 표시
- `moveSelectedShape(delta)` - 선택된 도형 이동

#### 레이어
- `zIndex` 필드로 순서 관리
- `bringShapeToFront()` - 앞으로
- `sendShapeToBack()` - 뒤로

#### 잠금
- `isLocked` 필드
- `toggleShapeLock()` - 잠금 토글
- 잠긴 도형은 이동/수정 불가

#### 스냅/격자
- 도형 모드에서 25px 격자 스냅
- `snapEnabled` 토글 가능
- `_snapToGrid()` - 좌표 스냅

---

### 8.4 도형 수정 권한

```dart
enum ShapePermission {
  all,        // 모두 수정 가능
  authorOnly, // 작성자만
  adminOnly,  // Owner/Admin만
}
```

---

## 결과

| 항목 | 상태 |
|------|------|
| 선 | ✅ 완료 |
| 화살표 | ✅ 완료 |
| 사각형 | ✅ 완료 |
| 원/타원 | ✅ 완료 |
| 선 색상/굵기 | ✅ 완료 |
| 채우기 색상/투명도 | ✅ 완료 |
| 선택/이동 | ✅ 완료 |
| 레이어 (앞/뒤) | ✅ 완료 |
| 잠금 | ✅ 완료 |
| 스냅/격자 | ✅ 완료 |
| Firestore 저장 | ✅ 완료 |
| 실시간 동기화 | ✅ 완료 |

---

## 변경된 파일

### 신규 생성

- `lib/models/shape_model.dart` – 도형 모델
- `lib/services/shape_service.dart` – 도형 Firestore 서비스

### 수정

- `lib/screens/canvas/canvas_controller.dart`
  - `InputMode.shape` 추가
  - 도형 관련 변수/메서드 추가
  - 도형 스트림 구독
- `lib/widgets/canvas/drawing_canvas.dart`
  - 도형 렌더링 (`_drawShape`, `_drawCurrentShape`)
  - 화살표 렌더링 (`_drawArrow`)
  - 선택 핸들 (`_drawHandle`)
  - 도형 모드 입력 처리
- `lib/widgets/canvas/pen_toolbar.dart`
  - 도형 선택 PopupMenu

### 문서 업데이트

- `잉크_앱프로젝트_정보/개발_순서.md` – Phase 8 체크 완료

---

## 관련 커밋

- **커밋 해시:** `8286a59`
- **커밋 메시지:** Phase 8 완료: 도형/선

---

## Firestore 데이터 구조

### shapes 컬렉션
```
rooms/{roomId}/shapes/{shapeId}
{
  "roomId": "...",
  "senderId": "...",
  "type": "rectangle",
  "startX": 100.0,
  "startY": 100.0,
  "endX": 200.0,
  "endY": 150.0,
  "strokeColor": "#000000",
  "strokeWidth": 2.0,
  "fillColor": "#FF0000",
  "fillOpacity": 0.5,
  "lineStyle": "solid",
  "isLocked": false,
  "zIndex": 0,
  "createdAt": Timestamp,
  "isDeleted": false
}
```

---

## 테스트 방법

```bash
cd /Users/ojaebaek/ink/ink_talk
flutter run
```

### 도형 그리기
1. 툴바에서 **도형 버튼** (사각형 아이콘) 클릭
2. 드롭다운에서 **선/화살표/사각형/원** 선택
3. 캔버스에서 **드래그**하여 도형 생성

### 도형 선택
1. 도형 클릭 → 골드 테두리 + 핸들 표시

---

## 기술 선택 이유

| 기술 | 선택 이유 |
|------|-----------|
| **별도 shapes 컬렉션** | 스트로크/텍스트와 분리하여 레이어 관리 |
| **zIndex 필드** | 레이어 순서 관리 용이 |
| **소프트 삭제** | Undo 가능성 |
| **PopupMenuButton** | 도형 종류 선택 UI |

---

## 알려진 제한사항 / TODO

- [ ] 도형 크기 조절 (핸들 드래그)
- [ ] 도형 회전
- [ ] 점선/점점선 실제 렌더링
- [ ] 도형 스타일 UI (색상 팔레트)
- [ ] 권한에 따른 편집 제한 실제 적용

---

## 참고 문서

- `잉크_앱프로젝트_정보/INK_최종_기능_명세서_v1.0.md` (6장 도형/선)
- `잉크_앱프로젝트_정보/INK_디자인_명세서_v1.0.md` (9장 도형/선)
- `잉크_앱프로젝트_정보/개발_순서.md`

---

## 다음 단계

| Phase | 내용 |
|-------|------|
| **9** | 업로드/첨부 (사진/영상/PDF) |
| **10** | 내보내기 (Export) |
| **11** | 시간순 네비게이션 |
