# [006] Phase 6 실시간 동기화 (핵심)

## 요청 정보

- **날짜:** 2026-01-29
- **요청 내용:** 개발 순서 Phase 6 (실시간 동기화) 진행
  - 6.1 스트로크 실시간 전송
  - 6.2 고스트 라이팅
  - 6.3 작성자 표시
  - 6.4 호버 사용자 식별

---

## 진행 내용

### 6.1 스트로크 실시간 전송

#### StrokeService 생성
```
lib/services/stroke_service.dart
```

- **Firestore 실시간 스트림**: `rooms/{roomId}/strokes` 컬렉션 구독
- **스트로크 저장**: 새 스트로크 Firestore에 추가
- **스트로크 확정**: `isConfirmed` 플래그 업데이트
- **스트로크 삭제**: 소프트 삭제 (`isDeleted: true`)

#### Douglas-Peucker 알고리즘
- 좌표 데이터 압축 (epsilon = 1.0)
- 불필요한 중간 점 제거
- 네트워크 트래픽 절감

```dart
static List<StrokePoint> simplifyPoints(List<StrokePoint> points, double epsilon)
```

---

### 6.2 고스트 라이팅

#### 동작 원리
1. 사용자가 그리기 시작 → **반투명(60%)** 표시
2. 그리기 완료 → Firestore에 저장 (`isConfirmed: false`)
3. **2초 후** → 확정 (`isConfirmed: true`) → **100% 불투명**

#### 구현
```dart
// 확정 타이머
_confirmTimer = Timer(_confirmDelay, () {
  _confirmStroke(stroke);
});

static const _confirmDelay = Duration(seconds: 2);
```

#### 투명도 설정
| 상태 | 투명도 |
|------|--------|
| 현재 그리는 중 | 70% |
| 저장됨 (미확정) | 60% |
| 확정됨 | 100% |
| 다른 사용자 고스트 | 40% |

---

### 6.3 작성자 표시

#### 데이터 저장
- 모든 스트로크에 `senderId` 저장
- 스타일 정보: 색상, 굵기, 펜 타입

#### 작성자 툴팁
- **패드**: 펜 호버 시 툴팁 표시
- **폰**: 짧게 터치 시 툴팁 표시
- 2초 후 자동 숨김

```dart
// 펜 호버 감지
void _onPointerHover(PointerHoverEvent event) {
  final isStylus = event.kind == PointerDeviceKind.stylus;
  if (isStylus) {
    _checkAuthorAtPoint(localPoint, event.localPosition);
  }
}

// 짧은 탭 감지
void _onTapUp(TapUpDetails details) {
  _checkAuthorAtPoint(localPoint, details.localPosition);
}
```

---

### 6.4 호버 사용자 식별

#### 펜 근접 감지
- `PointerDeviceKind.stylus` 감지
- 근접한 스트로크의 작성자 정보 표시

#### 자동 색상 구분 (AUTO)
```dart
class UserAutoColor {
  static final List<Color> _colors = [
    Color(0xFF1E88E5), // 파랑
    Color(0xFFE53935), // 빨강
    Color(0xFF43A047), // 초록
    // ... 8가지 색상
  ];

  static Color getColor(String userId) {
    // 사용자별 고유 색상 할당
  }
}
```

---

## 결과

| 항목 | 상태 |
|------|------|
| Firestore 실시간 스트림 | ✅ 완료 |
| Douglas-Peucker 압축 | ✅ 완료 |
| 고스트 라이팅 (반투명) | ✅ 완료 |
| 2초 후 확정 | ✅ 완료 |
| 작성자 정보 저장 | ✅ 완료 |
| 패드 펜 호버 툴팁 | ✅ 완료 |
| 폰 터치 툴팁 | ✅ 완료 |
| 사용자별 자동 색상 | ✅ 완료 |

---

## 변경된 파일

### 신규 생성

- `lib/services/stroke_service.dart` – 스트로크 실시간 동기화 서비스

### 수정

- `lib/screens/canvas/canvas_controller.dart` – 실시간 동기화 연동, 고스트 라이팅
- `lib/widgets/canvas/drawing_canvas.dart` – 서버/로컬 스트로크 렌더링, 작성자 툴팁
- `lib/screens/canvas/canvas_screen.dart` – 컨트롤러 초기화

### 문서 업데이트

- `잉크_앱프로젝트_정보/개발_순서.md` – Phase 6 체크 완료

---

## 관련 커밋

- **커밋 해시:** `f9a986a`
- **커밋 메시지:** Phase 6 완료: 실시간 동기화

---

## Firestore 데이터 구조

### strokes 컬렉션
```
rooms/{roomId}/strokes/{strokeId}
{
  "roomId": "...",
  "senderId": "...",
  "points": [
    {"x": 100, "y": 200, "p": 1.0, "t": 1706500000000},
    ...
  ],
  "style": {
    "color": "#1E88E5",
    "width": 2.0,
    "penType": "pen1"
  },
  "createdAt": Timestamp,
  "isConfirmed": true,
  "isDeleted": false
}
```

---

## 테스트 방법

```bash
cd /Users/ojaebaek/ink/ink_talk
flutter run
```

1. **설정 → 테스트 채팅방 생성**
2. **펜으로 그리기** → 반투명으로 표시
3. **2초 대기** → 100% 확정
4. **앱 재시작** → 스트로크 유지 확인
5. **스트로크 터치/호버** → 작성자 툴팁

---

## 기술 선택 이유

| 기술 | 선택 이유 |
|------|-----------|
| **Firestore** | 실시간 스트림, 오프라인 지원, 확장성 |
| **Douglas-Peucker** | 좌표 압축으로 네트워크 트래픽 절감 |
| **소프트 삭제** | Undo 가능성, 데이터 복구 |

---

## 개발 중 발생한 오류 및 대처

### 오류 1: private 필드 접근

**증상:**
```
The getter '_localStrokes' isn't defined for the type 'CanvasController'
```

**원인:**
- `_localStrokes`가 private이라 외부 클래스에서 접근 불가

**해결:**
- public getter 추가: `List<LocalStrokeData> get localStrokes`

---

### 오류 2: Color.value deprecated

**증상:**
```
'value' is deprecated and shouldn't be used. Use component accessors like .r or .g, or toARGB32
```

**원인:**
- Flutter 최신 버전에서 `Color.value` 사용 지양

**해결:**
- `color.value` → `color.toARGB32()` 변경

---

## 알려진 제한사항 / TODO

- [ ] 친구만 / 전체 / OFF 호버 설정
- [ ] 다른 사용자 실시간 고스트 표시 (커서 위치)
- [ ] Redo 기능 (서버에서 복구)
- [ ] 실제 사용자 이름 조회 (현재 ID 일부 표시)
- [ ] **펜 전용 모드 토글 제거 또는 설정으로 이동** (테스트용 임시 기능)

---

## 추가 수정 (2026-01-29)

### 펜 전용 모드 토글 (테스트용)

**배경:**
- 컴퓨터에서 테스트 시 스타일러스가 없어 그리기 기능 테스트 불가
- 임시로 마우스/터치로도 그릴 수 있는 토글 추가

**구현:**
- 툴바 우측에 `PEN` / `ALL` 토글 버튼
- `PEN`: 펜(스타일러스)으로만 그리기 (기본값 OFF)
- `ALL`: 마우스/터치로도 그리기 가능

**코드 위치:**
- `CanvasController._penOnlyMode`
- `DrawingCanvas._onPointerDown/Move/Up`
- `PenToolbar._buildPenOnlyToggle()`

**TODO:**
- 프로덕션 배포 전 제거하거나 설정 화면으로 이동 필요

---

## 참고 문서

- `잉크_앱프로젝트_정보/INK_최종_기능_명세서_v1.0.md` (5.4 고스트 라이팅)
- `잉크_앱프로젝트_정보/INK_디자인_명세서_v1.0.md` (6.2 고스트 라이팅)
- `잉크_앱프로젝트_정보/개발_순서.md`

---

## 다음 단계

| Phase | 내용 |
|-------|------|
| **7** | 도형/선 + 편집 시스템 |
| **8** | 텍스트 입력 |
| **9** | 업로드/첨부 |
