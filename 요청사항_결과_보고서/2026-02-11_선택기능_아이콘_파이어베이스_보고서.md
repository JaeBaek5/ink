# 2026년 2월 11일 작업 보고서

선택 도구 활성화, 아이콘 변경, Firebase 사용 현황 및 요금 절감 검토를 정리한 보고서입니다.

---

## 1. 진행한 작업 요약

### 1.1 손글씨 자유형/사각형 선택 기능 활성화

- **자유형 선택(올가미)**: 사용자가 그린 경로 내부에 있는 스트로크를 선택. 경로는 폐곡선으로 처리(처음·끝 연결)하여 내부 판정.
- **사각형 선택**: 드래그한 사각형 영역과 겹치는 스트로크를 선택.
- **다중 선택**: 한 번에 여러 스트로크 선택 가능.
- **이동**: 선택된 스트로크 위에서 드래그 시 캔버스 좌표 기준으로 이동. Firestore `updateStrokePoints`로 서버 반영.
- **삭제**: 선택 액션 바의 "삭제" 버튼으로 선택 스트로크 일괄 삭제(소프트 삭제). Undo 지원.
- **복사**: "복사" 버튼으로 선택 스트로크를 (24, 24) 오프셋 적용 후 새 스트로크로 저장.
- **선택 해제**: "선택 해제" 버튼 또는 빈 영역을 새로 선택 시 기존 선택 해제.
- **입력**: 스타일러스·마우스·손가락 모두 선택 그리기/이동에 사용 가능. 선택 모드에서 단일 포인터 드래그 시 캔버스 팬이 아닌 선택 동작으로 처리.

**수정/추가 파일**

- `stroke_service.dart`: 스트로크 포인트 일괄 업데이트용 `updateStrokePoints(roomId, strokeId, points)` 추가.
- `canvas_controller.dart`: 선택 상태(`selectedStrokeIds`, `selectionPath`, `selectionRect`), 올가미/사각형 내 스트로크 판정, `startSelection`/`updateSelection`/`endSelection`, `startMovingSelection`/`updateMovingSelection`/`endMovingSelection`, `deleteSelectedStrokes`, `copySelectedStrokes`, `clearStrokeSelection`, `isPointOnSelectedStroke` 등 추가.
- `drawing_canvas.dart`: 선택 도구일 때 포인터 다운/무브/업을 선택 그리기 또는 선택 이동으로 분기, 선택 영역·선택된 스트로크 하이라이트 그리기 추가. 선택 그리기/이동 중에는 캔버스 팬 비활성화.
- `pen_toolbar.dart`: 선택된 스트로크가 있을 때 "N개 선택", 삭제, 복사, 선택 해제 버튼이 있는 선택 액션 바(`_buildStrokeSelectionBar`) 추가.

### 1.2 자유형 선택 시 처음–끝 연결선 표시 제거

- **요구사항**: 올가미 선택 시 처음 점과 마지막 점을 잇는 선으로 폐곡선을 만들되, **그리는 동안에는 그 연결선이 보이지 않게** 할 것.
- **구현**: 선택 경로를 그릴 때는 `path.close()`를 호출하지 않고, **선택 영역 그리기**에서는 열린 경로만 그려서 처음–끝을 잇는 선이 화면에 표시되지 않도록 함. **선택 완료(내부 판정)** 시에는 기존처럼 처음과 끝을 연결한 폐곡선으로 판정하여 기능은 동일하게 유지.

### 1.3 펜/연필/만년필/브러시/형광펜/지우개 아이콘 변경 (S노트 스타일)

- **패키지**: `material_symbols_icons` 추가.
- **변경 내용**:
  - 펜: `Icons.edit` → `Symbols.stylus_pen`
  - 연필: `Icons.create` → `Symbols.stylus_pencil`
  - 만년필: `Icons.brush_outlined` → `Symbols.stylus_fountain_pen`
  - 브러시: `Icons.brush` → `Symbols.stylus_brush`
  - 형광펜: `Icons.format_paint` → `Symbols.ink_highlighter`
  - 지우개: `Icons.delete_outline` → `Symbols.ink_eraser`
- **적용 위치**: `pen_toolbar.dart`, `tool_dock.dart` (펜 슬롯·지우개 버튼·지우개 서브바 아이콘).

---

## 2. Firebase 사용 현황 정리

### 2.1 사용 중인 Firebase 제품

| 제품 | 용도 |
|------|------|
| Firebase Core | 앱 초기화 |
| Firebase Auth | 이메일/비밀번호·Google 로그인, 로그아웃, 계정 삭제 |
| Cloud Firestore | 방·스트로크·텍스트·도형·미디어 메타·친구·사용자·태그·감사 로그 등 실시간 동기화 |
| Firebase Storage | 사진/영상/PDF 업로드 및 URL 저장 |

### 2.2 사용하지 않는 제품

- **Firebase Realtime Database**: 미사용. 실시간 동기화는 **Cloud Firestore**의 `snapshots()` 리스너로 구현.
- Firebase Analytics, Crashlytics, FCM, Dynamic Links: 미사용.

### 2.3 Firestore 실시간(리스너) 사용 여부

- **사용 중**: 방·스트로크·텍스트·도형·미디어·친구·태그·인증 상태 등에서 `.snapshots()` 및 `.listen()`으로 실시간 구독.
- **과금**: 리스너는 최초 연결 시 결과 전체 1회 읽기, 이후에는 **변경된 문서만** 읽기로 과금. 폴링 대비 읽기 수가 적어 실시간 유지 시 요금 절감에 유리.

---

## 3. 실시간 유지 시 요금 절감 방안 검토

### 3.1 쓰기(Writes) 절감 (우선 적용 권장)

- **스트로크 확정**: `confirmStroke` 호출을 타이머로 묶어, 일정 간격(예: 2초)마다 변경된 스트로크만 배치 업데이트.
- **선택 스트로크 이동**: 여러 스트로크 이동 시 `updateStrokePoints`를 `WriteBatch`로 묶어 한 번에 커밋.
- **감사 로그**: 이벤트마다 쓰기 대신, 로컬 버퍼 후 주기적 일괄 쓰기 또는 중요 이벤트만 저장.

### 3.2 읽기(리스너) 절감

- **캔버스 이탈 시 구독 해제**: `CanvasController.dispose()`에서 strokes/texts/shapes/media 구독 취소 유지.
- **스트로크 수 제한**: 스트로크가 많은 방은 `getStrokesStream`에 `orderBy('createdAt').limit(500)` 등 적용 후, “이전 스트로크 더 보기”는 별도 쿼리로 로드 검토.

### 3.3 기타

- 쿼리 시 `offset` 대신 `startAfterDocument(lastDoc)` 등 커서 방식 유지.
- 보안 규칙 내 `get()`/`exists()` 사용 최소화하여 규칙 평가로 인한 추가 읽기 완화.

---

## 4. 참고 사항

- **Firestore 사용량**: 저장 용량 5KB 수준이면 무료 한도(1GB) 내. 요금은 주로 **쓰기·읽기 건수**에서 발생.
- **실시간 유지**: 현재처럼 Firestore 리스너를 사용하는 구성이, 동일한 실시간성을 폴링으로 구현할 때보다 읽기 비용이 적게 듦.

---

*작성일: 2026년 2월 11일*
