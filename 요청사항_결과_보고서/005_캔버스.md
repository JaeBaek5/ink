# [005] Phase 5 캔버스 (핵심 기능)

## 요청 정보

- **날짜:** 2026-01-29
- **요청 내용:** 개발 순서 Phase 5 (캔버스) 진행 + 테스트용 채팅방 생성
  - 5.1 캔버스 기본
  - 5.2 입력 정책 (패드)
  - 5.3 펜 스타일 툴바
  - 5.4 자동 색상 구분
  - 5.5 지우개

---

## 진행 내용

### 테스트용 채팅방 생성

- RoomService에 `createTestRoom()` 메서드 추가
- 설정 탭에 "테스트 채팅방 생성" 버튼 추가
- 생성 후 자동으로 캔버스 화면으로 이동

---

### 5.1 캔버스 기본

#### CanvasController
- 스트로크 데이터 관리 (`StrokeData`)
- 캔버스 변환 (offset, scale)
- Undo/Redo 스택

#### DrawingCanvas 위젯
- 무한 캔버스 (CustomPaint)
- 격자 배경 (50px 간격)
- 스트로크 렌더링 (Path)

#### 핀치 줌
- `GestureDetector.onScaleUpdate`
- 줌 범위: 0.1x ~ 5.0x
- 줌 중심점 유지

#### 캔버스 이동 (패닝)
- 한 손가락: 이동
- 두 손가락: 줌

---

### 5.2 입력 정책 (패드)

```
┌──────────────────────────────────┐
│ 입력 장치     │ 동작              │
├──────────────────────────────────┤
│ 손가락        │ 이동/선택/스크롤   │
│ 펜 (스타일러스)│ 글쓰기/그리기     │
│ 마우스        │ 글쓰기/그리기     │
└──────────────────────────────────┘
```

- `Listener.onPointerDown/Move/Up`
- `PointerDeviceKind` 감지 (stylus, touch, mouse)
- Apple Pencil / S Pen 자동 인식

---

### 5.3 펜 스타일 툴바 (상단 중앙)

#### 구조
```
[펜1][펜2][지우개] | [라쏘][사각] | [AUTO][색1][색2][색3] | [굵1][굵2][굵3] | [↩][↪] | [도형]
```

#### 펜 슬롯 (3개)
- 펜 1: 기본 검정
- 펜 2: 기본 파랑
- 지우개: 스트로크 단위 지우기

#### 선택 도구
- 라쏘 (자유형)
- 사각형

#### 색상 슬롯 (3개)
- 탭: 해당 색상 선택
- 롱프레스: 색상 팔레트에서 변경

#### 굵기 슬롯 (3개)
- 2px / 4px / 8px

#### Undo / Redo
- 스트로크 단위
- 활성화/비활성화 상태 표시

---

### 5.4 자동 색상 구분 (AUTO)

- AUTO 버튼 토글
- 활성화 시: 사용자별 자동 색상
- 비활성화 시: 수동 선택 색상
- 툴바에 AUTO 상태 표시

---

### 5.5 지우개

- 펜↔지우개 전환 (툴바)
- 스트로크 단위 지우기
- 지우개 크기: 20px

---

## 결과

| 항목 | 상태 |
|------|------|
| 테스트용 채팅방 생성 | ✅ 완료 |
| 무한 캔버스 | ✅ 완료 |
| 핀치 줌 | ✅ 완료 |
| 입력 정책 (펜/손가락) | ✅ 완료 |
| 펜 슬롯 (3개) | ✅ 완료 |
| 선택 도구 | ✅ 완료 |
| 색상 슬롯 (3개) | ✅ 완료 |
| 굵기 슬롯 (3개) | ✅ 완료 |
| Undo / Redo | ✅ 완료 |
| AUTO 색상 | ✅ 완료 |
| 지우개 | ✅ 완료 |

---

## 변경된 파일

### 신규 생성

- `lib/screens/canvas/canvas_screen.dart` – 캔버스(채팅방) 화면
- `lib/screens/canvas/canvas_controller.dart` – 캔버스 상태 관리
- `lib/widgets/canvas/drawing_canvas.dart` – 드로잉 캔버스 위젯
- `lib/widgets/canvas/pen_toolbar.dart` – 펜 툴바 위젯

### 수정

- `lib/services/room_service.dart` – `createTestRoom()` 추가
- `lib/providers/room_provider.dart` – `createTestRoom()` 추가
- `lib/screens/home/tabs/chat_tab.dart` – CanvasScreen으로 이동
- `lib/screens/home/tabs/settings_tab.dart` – 테스트 채팅방 생성 버튼

### 문서 업데이트

- `잉크_앱프로젝트_정보/개발_순서.md` – Phase 5 체크 완료

---

## 관련 커밋

- **커밋 해시:** `3d54ae7`
- **커밋 메시지:** Phase 5 완료: 캔버스 (테스트 채팅방 포함)

---

## 테스트 방법

```bash
cd /Users/ojaebaek/ink/ink_talk
flutter run
```

### 테스트 채팅방 생성
1. 로그인 후 설정 탭 이동
2. "개발자" 섹션에서 "테스트 채팅방 생성" 클릭
3. 캔버스 화면 자동 진입

### 캔버스 테스트
1. **그리기**: Apple Pencil 또는 마우스로 그리기
2. **이동**: 손가락으로 드래그
3. **줌**: 두 손가락 핀치
4. **펜 전환**: 툴바에서 펜1/펜2/지우개 선택
5. **색상 변경**: 색상 슬롯 탭 또는 롱프레스
6. **굵기 변경**: 굵기 슬롯 탭
7. **Undo/Redo**: 툴바 버튼

---

## 기술 선택 이유

| 기술 | 선택 이유 |
|------|-----------|
| **CustomPaint** | 무한 캔버스, 고성능 렌더링 |
| **Listener** | PointerDeviceKind 감지 (stylus vs touch) |
| **ChangeNotifier** | 캔버스 상태 반응형 관리 |

---

## 개발 중 발생한 오류 및 대처

### 오류 1: unused_import 경고

**증상:**
```
Unused import: 'package:flutter/services.dart'
```

**해결:**
- 불필요한 import 제거

---

### 오류 2: unused_field 경고

**증상:**
```
The value of the field '_baseOffset' isn't used
```

**원인:**
- 줌 기능에서 사용하려던 변수가 실제로 사용되지 않음

**해결:**
- 변수 선언 및 할당 제거

---

## 알려진 제한사항 / TODO

- [ ] 픽셀 단위 지우기 (선택 기능)
- [ ] 사용자별 자동 색상 할당 로직
- [ ] 스트로크 Firestore 저장/로드
- [ ] 고스트 라이팅 (실시간 표시)
- [ ] 선택 도구 실제 기능 구현
- [ ] 도형 도구 구현
- [ ] 작성자 표시
- [ ] 시간순 네비게이션

---

## 참고 문서

- `잉크_앱프로젝트_정보/INK_최종_기능_명세서_v1.0.md` (5장 캔버스)
- `잉크_앱프로젝트_정보/INK_디자인_명세서_v1.0.md` (5.2 펜 툴바)
- `잉크_앱프로젝트_정보/개발_순서.md`

---

## 다음 단계

| Phase | 내용 |
|-------|------|
| **6** | 도형/선 + 편집 시스템 |
| **7** | 텍스트 입력 |
| **8** | 업로드/첨부 |
