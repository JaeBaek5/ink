# [015] Phase 14 성능 최적화

## 요청 정보

- **날짜:** 2026-01-29
- **요청 내용:** 개발 순서 Phase 14 성능 최적화 진행
  - 14.1 실시간 최적화 (경량 스트림, 미디어 별도·캐시)
  - 14.2 로딩 최적화 (썸네일 우선, 원본 지연)
  - 14.3 전송 상태 표시
  - 14.4 네트워크 불안정 처리 (재연결 배너, 대기열)

---

## 진행 내용

### 14.1 실시간 최적화

- **스트로크/도형/호버:** 기존 Firestore `snapshots()` 유지(메타데이터 제외). 스트로크·도형·텍스트·미디어는 각각 별도 컬렉션 스트림으로 구독.
- **사진/영상/PDF 별도 채널 + 캐시**
  - 미디어는 `rooms/{roomId}/media` 스트림으로만 수신.
  - `MediaCacheService`: 인메모리 캐시(로드 완료 키 기록).
  - 이미지: `CachedNetworkImage`로 네트워크 이미지 캐시.

### 14.2 로딩 최적화

- **썸네일/프리뷰 우선 로딩**
  - 이미지: `thumbnailUrl`이 있으면 placeholder에서 썸네일 먼저 표시 후 원본 로드.
  - 영상: `thumbnailUrl`이 있으면 재생 전까지 썸네일만 표시.
- **원본 지연 로딩**
  - 영상: `VideoPlayerController`를 재생 버튼 탭 시에만 초기화(`_initVideoController()`).
  - 이미지: `CachedNetworkImage`의 placeholder로 썸네일 또는 로딩 스피너 표시 후 원본 로드.

### 14.3 전송 상태 표시

- **전송 중**
  - 앱바 서브타이틀에 `전송 중 N건`(로컬 스트로크 + 대기열), `업로드 중`(미디어 업로드 중) 표시.
  - `CanvasController.sendingStrokesCount` = `_localStrokes.length + _pendingRetry.length`.
  - `isUploading`은 기존대로 미디어 업로드 시 true.
- **완료:** 스트로크는 확정 후 `_localStrokes`에서 제거되어 서버 스트로크로만 표시되므로, 전송 중 건수만 표시해도 완료 상태는 자연스럽게 반영됨.

### 14.4 네트워크 불안정 처리

- **재연결 중 배너**
  - `connectivity_plus`로 연결 상태 구독.
  - `NetworkConnectivityService`: `isOnline`(wifi/mobile/other면 true), `addListener`로 화면에서 구독.
  - 오프라인 시 캔버스 상단에 주황색 배너: "네트워크 연결이 불안정합니다. 재연결 중...".
- **대기열**
  - 스트로크 저장 실패 시 해당 스트로크를 `_pendingRetry`에 보관하고 로컬에는 계속 표시(고스트).
  - 배너에 "대기열 N건 전송 대기" 표시, 온라인 시 "재시도" 버튼으로 수동 재전송 가능.
  - `NetworkConnectivityService`가 온라인으로 바뀌면 자동으로 `retryPendingStrokes()` 호출.

---

## 결과

- [x] 14.1 스트로크/도형 경량 스트림 유지, 미디어 별도 스트림 + MediaCacheService·CachedNetworkImage
- [x] 14.2 이미지 썸네일 우선, 영상 썸네일 우선·재생 시 원본 로딩
- [x] 14.3 앱바에 전송 중 N건·업로드 중 표시
- [x] 14.4 재연결 배너, 대기열 표시·재시도·온라인 시 자동 재전송

---

## 변경된 파일

| 구분 | 경로 |
|------|------|
| 수정 | `ink_talk/pubspec.yaml` (connectivity_plus, cached_network_image) |
| 신규 | `ink_talk/lib/services/network_connectivity_service.dart` |
| 신규 | `ink_talk/lib/services/media_cache_service.dart` |
| 수정 | `ink_talk/lib/main.dart` (NetworkConnectivityService Provider) |
| 수정 | `ink_talk/lib/screens/canvas/canvas_controller.dart` (대기열, 재시도, sendingStrokesCount) |
| 수정 | `ink_talk/lib/screens/canvas/canvas_screen.dart` (배너, 전송 상태, 네트워크 리스너) |
| 수정 | `ink_talk/lib/widgets/canvas/media_widget.dart` (썸네일 우선, CachedNetworkImage, 영상 지연 로딩) |
| 수정 | `잉크_앱프로젝트_정보/개발_순서.md` (Phase 14 체크) |

---

## 테스트 방법

1. **전송 상태:** 캔버스에서 스트로크 그리기 → 앱바에 "전송 중 1건" 표시 후 사라짐. 미디어 업로드 시 "업로드 중" 표시.
2. **재연결 배너:** Wi‑Fi/데이터 끄기 → 캔버스 상단 주황 배너 "재연결 중..." 확인. 다시 연결 시 배너 사라짐.
3. **대기열:** 오프라인 상태에서 스트로크 그리기 → "대기열 1건 전송 대기" 배너. 온라인 복구 시 자동 재전송 또는 "재시도" 탭으로 재전송.
4. **썸네일/지연:** 미디어에 thumbnailUrl 있으면 이미지·영상 썸네일 먼저 표시. 영상은 재생 탭 시 원본 로드.

---

## 알려진 제한사항 / TODO

- `MediaCacheService`는 생성했으나 위젯에서 아직 사용하지 않음. CachedNetworkImage가 캐시를 담당.
- 스트로크/도형 Firestore 스트림은 기존 구조 유지. 메타데이터 제외 옵션은 기본 동작으로 충족.
- 대기열은 스트로크만 대상. 텍스트·도형·미디어 저장 실패 시 대기열 미적용(추후 확장 가능).

---

## 참고 문서

- `잉크_앱프로젝트_정보/개발_순서.md` Phase 14
