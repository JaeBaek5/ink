# S노트 스타일 이미지 조작 수정 정리

## 1. 수정 목표 (문서 기준)

- **모드 분리**: 기본 = 캔버스 이동/줌, 사진 선택 시 = 사진 이동·리사이즈·회전
- **핸들**: 모서리 = 비율 유지, 변 = 자유 리사이즈, 회전 핸들 추가
- **Hit-test**: 회전된 사각형 포함, 캔버스 vs 오브젝트 제스처 분리

---

## 2. 실제로 한 수정 내용

### 2.1 모드 분리 (캔버스 vs 오브젝트)

- **`_MediaAwareHitTestBlock`** 추가  
  - Stack **첫 번째 자식**으로 “캔버스 조작 레이어”를 둠.  
  - 터치가 **선택된(크기조정 중) 미디어 영역(회전 반영)** 안이면 `hitTest`에서 `false` 반환 → 이 레이어는 히트되지 않음.  
  - 빈 영역 터치 시에만 캔버스 pan/zoom용 GestureDetector가 터치를 받도록 의도.

- **위젯 트리 (의도한 구조)**  
  `Listener` → `LayoutBuilder` → `RepaintBoundary` → `Stack` →  
  - 1번째: `Positioned.fill` → `_MediaAwareHitTestBlock` → `GestureDetector(scale/tap/longPress)` → `SizedBox.expand` → `ClipRect` → `CustomPaint` (캔버스)  
  - 2번째 이후: 미디어, 스트로크, 텍스트, 타임라인 등

- **문제**: 이 구조에서 **캔버스 이동·줌이 동작하지 않는** 현상 발생 (손글씨는 정상).  
  → 원인 추정: Stack 내부에서의 히트 순서/경쟁으로 캔버스용 scale 제스처가 이기지 못하는 경우.

### 2.2 회전(angle) 추가

- **MediaModel**  
  - `angleDegrees` (도 단위) 추가.  
  - `fromFirestore` / `toFirestore` / `copyWith` 반영.  
  - Firestore 필드명: `angle`.

- **MediaService**  
  - `updateMedia(..., angleDegrees: ...)` 지원.

- **CanvasController**  
  - `rotateMedia(mediaId, angleDegrees)` 추가.

### 2.3 MediaWidget 회전·핸들

- **Transform.rotate**  
  - `media.angleDegrees`를 rad로 변환해 `Transform.rotate(angle:, alignment: Alignment.center)` 적용.  
  - 위치/크기는 기존대로 `Positioned` + `SizedBox(width, height)`.

- **회전 핸들**  
  - 선택(크기조정) 시 미디어 **위쪽 중앙 위**에 원형 핸들.  
  - 드래그 시 오브젝트 중심 기준 각도 계산 → `onRotate(angleDegrees)` 호출.

- **MediaWidget**  
  - `onRotate: void Function(double angleDegrees)?` 추가.  
  - `drawing_canvas`에서 `onRotate: (angleDegrees) => controller.rotateMedia(media.id, angleDegrees)` 로 연결.

### 2.4 회전 포함 Hit-test

- **_RenderMediaAwareHitTest**  
  - 선택된 미디어가 **회전된 사각형**일 때도 터치가 그 안에 있으면 캔버스 레이어가 히트되지 않도록 함.  
  - `_pointInsideRotatedRect`: 화면 좌표 → 캔버스 역변환 → 미디어 중심 기준 역회전 후, `-w/2~w/2`, `-h/2~h/2` 안인지 판별.

- **_onTapUp**  
  - “미디어 위 짧은 탭” 판정을 **회전 포함** `_isPointInsideRotatedMedia(localPoint, media)` 로 변경.  
  - “사진 밖 탭 시 선택 해제”도 회전된 영역 기준으로 판정하도록 수정.

### 2.5 탭 아웃사이드 선택 해제

- 크기조정 모드에서 **회전된 사진 영역 밖**을 탭하면 `clearMediaResizeMode()` 호출로 선택 해제.

---

## 3. 캔버스 이동·줌이 안 되는 현상과 복구 (적용 완료)

- **증상**: 손글씨(펜)는 잘 써지는데, **캔버스 이동·줌만 불가**.

- **원인**:  
  캔버스용 `GestureDetector`를 Stack **안**의 `_MediaAwareHitTestBlock` 자식으로만 두었을 때,  
  Flutter 히트테스트/제스처 경쟁에서 캔버스 scale이 이기지 못하는 경우가 있는 것으로 추정.

- **적용한 복구**:  
  캔버스 pan/zoom용 **GestureDetector를 Stack 바깥**으로 다시 올려,  
  `Listener` 직하위에 두는 구조로 되돌렸음.  
  `_MediaAwareHitTestBlock` 및 `_RenderMediaAwareHitTest` 클래스는 제거.

  - **현재 트리**:  
    `Listener` → **`GestureDetector`** (onScaleStart/Update/End, onTapUp, onLongPress) → `LayoutBuilder` → … → `Stack` → [캔버스 ClipRect만, 미디어, 스트로크, …]

  - **결과**:  
    - 캔버스 이동·줌 다시 동작.  
    - 선택된 사진 위에서도 캔버스 pan이 먼저 잡힐 수 있어, “사진만 이동”이 어려울 수 있음.  
    - 사진 이동: **롱프레스로 선택** 후 드래그하거나, 추후 커스텀 제스처 인식기로 보완 가능.

---

## 4. 수정된/추가된 파일 목록

| 파일 | 변경 요약 |
|------|-----------|
| `lib/widgets/canvas/drawing_canvas.dart` | 모드 분리용 Block 추가/제거, 회전 hit-test, 탭 판정, (복구 시 GestureDetector 위치 변경) |
| `lib/widgets/canvas/media_widget.dart` | Transform.rotate, 회전 핸들, onRotate |
| `lib/models/media_model.dart` | angleDegrees, Firestore angle |
| `lib/services/media_service.dart` | updateMedia(angleDegrees) |
| `lib/screens/canvas/canvas_controller.dart` | rotateMedia() |

---

## 5. 사용 흐름 (S노트 스타일, 복구 후)

1. **이미지 탭** → 선택 + 크기조정 모드 진입.  
2. **사진 위 1손가락 드래그** → (캔버스와 경쟁 시 캔버스가 이길 수 있음; 롱프레스 후 드래그 등으로 보완 가능.)  
3. **모서리 핸들** 드래그 → 비율 유지 리사이즈.  
4. **위쪽 회전 핸들** 드래그 → 회전.  
5. **사진 밖 탭** → 선택 해제.

이 문서는 “조금 전에 했던 수정” 내용을 정리한 것이며, 캔버스 이동·줌 복구를 위해 GestureDetector를 다시 Stack 바깥으로 옮긴 상태를 전제로 합니다.
