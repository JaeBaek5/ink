# [009] Phase 9 업로드/첨부

## 요청 정보

- **날짜:** 2026-01-29
- **요청 내용:** 개발 순서 Phase 9 (업로드/첨부) 진행
  - 9.1 사진 (PNG/JPG)
  - 9.2 영상
  - 9.3 문서 (PDF)
  - 9.4 오브젝트 롱프레스

---

## 진행 내용

### 9.1 사진 (PNG/JPG)

| 기능 | 구현 |
|------|------|
| 업로드 | `image_picker` 갤러리 선택 |
| Firebase Storage | 자동 업로드 + URL 저장 |
| 크기 설정 | 기본 200x200, 드래그 이동 |
| 롱프레스 옵션 | Dim 배경 + 팝업 메뉴 |
| 투명도 설정 | Slider (0.1 ~ 1.0) |

---

### 9.2 영상

| 기능 | 구현 |
|------|------|
| 업로드 | `image_picker` 영상 선택 (최대 5분) |
| 재생 | `video_player` 패키지 |
| 재생 버튼 | 중앙 play/pause 버튼 |
| 재생 바 | 하단 `VideoProgressIndicator` |
| 크기 조절 | 드래그로 이동 |

---

### 9.3 문서 (PDF)

| 기능 | 구현 |
|------|------|
| 업로드 | `file_picker` PDF 선택 |
| 표시 | 파일명 + 아이콘 + 페이지 정보 |
| 페이지 넘김 | 좌/우 반투명 버튼 |
| 크기 조절 | 기본 250x350 |

---

### 9.4 오브젝트 롱프레스

| 기능 | 구현 |
|------|------|
| 배경 Dim | `Colors.black.withValues(alpha: 0.5)` |
| 팝업 메뉴 | BottomSheet 스타일 |
| 옵션 | 투명도 조절, 앞으로, 뒤로, 삭제 |

---

## 결과

| 항목 | 상태 |
|------|------|
| 사진 업로드 | ✅ 완료 |
| 사진 표시 | ✅ 완료 |
| 사진 투명도 | ✅ 완료 |
| 영상 업로드 | ✅ 완료 |
| 영상 재생 | ✅ 완료 |
| 영상 재생 바 | ✅ 완료 |
| PDF 업로드 | ✅ 완료 |
| PDF 페이지 넘김 | ✅ 완료 |
| 롱프레스 Dim | ✅ 완료 |
| 롱프레스 팝업 | ✅ 완료 |
| Firebase Storage | ✅ 완료 |
| Firestore 동기화 | ✅ 완료 |

---

## 변경된 파일

### 신규 생성

- `lib/models/media_model.dart` – 미디어 모델
- `lib/services/media_service.dart` – 미디어 서비스 (Storage + Firestore)
- `lib/widgets/canvas/media_widget.dart` – 미디어 위젯 (이미지/영상/PDF)

### 수정

- `lib/screens/canvas/canvas_controller.dart`
  - `_mediaService`, `_mediaSubscription` 추가
  - `uploadImage`, `uploadVideo`, `uploadPdf` 메서드
  - `moveMedia`, `resizeMedia`, `setMediaOpacity` 메서드
  - `deleteMedia`, `bringMediaToFront`, `sendMediaToBack` 메서드
- `lib/widgets/canvas/drawing_canvas.dart`
  - `MediaWidget` 렌더링
  - `_showMediaOptions` 롱프레스 메뉴
- `lib/widgets/canvas/pen_toolbar.dart`
  - `_buildMediaButtons()` 추가
- `pubspec.yaml`
  - `firebase_storage: ^13.0.1`
  - `image_picker: ^1.1.2`
  - `file_picker: ^8.1.7`
  - `video_player: ^2.9.3`

### 문서 업데이트

- `잉크_앱프로젝트_정보/개발_순서.md` – Phase 9 체크 완료

---

## 관련 커밋

- **커밋 해시:** `2ffc40e`
- **커밋 메시지:** Phase 9 완료: 업로드/첨부

---

## Firestore 데이터 구조

### media 컬렉션
```
rooms/{roomId}/media/{mediaId}
{
  "roomId": "...",
  "senderId": "...",
  "type": "image" | "video" | "pdf",
  "url": "https://firebasestorage.googleapis.com/...",
  "fileName": "photo.jpg",
  "fileSize": 123456,
  "thumbnailUrl": null,
  "x": 100.0,
  "y": 100.0,
  "width": 200.0,
  "height": 200.0,
  "opacity": 1.0,
  "zIndex": 0,
  "totalPages": 5,  // PDF only
  "createdAt": Timestamp,
  "isDeleted": false
}
```

---

## Firebase Storage 구조

```
rooms/{roomId}/media/{timestamp}_{filename}
```

---

## 테스트 방법

```bash
cd /Users/ojaebaek/ink/ink_talk
flutter run
```

### 미디어 업로드
1. 툴바에서 **사진/영상/PDF 버튼** 클릭
2. 갤러리/파일 선택
3. 캔버스에 자동 배치

### 미디어 조작
1. **탭** → 선택 (골드 테두리)
2. **드래그** → 이동
3. **롱프레스** → 옵션 메뉴
   - 투명도 조절
   - 앞으로/뒤로
   - 삭제

---

## 기술 선택 이유

| 기술 | 선택 이유 |
|------|-----------|
| **Firebase Storage** | 파일 저장소, 자동 URL 생성 |
| **image_picker** | 갤러리 이미지/영상 선택 |
| **file_picker** | PDF 등 문서 파일 선택 |
| **video_player** | Flutter 공식 영상 재생 |
| **별도 media 컬렉션** | 미디어 독립 관리, 레이어 순서 |

---

## 알려진 제한사항 / TODO

- [ ] PDF 실제 렌더링 (현재 아이콘 + 파일명만 표시)
- [ ] PDF 펼쳐보기 패널
- [ ] 미디어 크기 조절 핸들
- [ ] 영상 썸네일 생성
- [ ] 업로드 진행률 UI
- [ ] 카메라 촬영 업로드

---

## 참고 문서

- `잉크_앱프로젝트_정보/INK_최종_기능_명세서_v1.0.md` (11장 업로드/첨부)
- `잉크_앱프로젝트_정보/INK_디자인_명세서_v1.0.md` (10장 업로드/첨부)
- `잉크_앱프로젝트_정보/개발_순서.md`

---

## 다음 단계

| Phase | 내용 |
|-------|------|
| **10** | 내보내기 (Export) |
| **11** | 시간순 네비게이션 |
| **12** | 모아보기 (태그함) |
