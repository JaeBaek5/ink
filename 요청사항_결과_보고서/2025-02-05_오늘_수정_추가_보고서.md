# 2025년 2월 5일 작업 보고서

오늘 수정·추가한 내용을 정리한 보고서입니다.

---

## 1. 이미지 업로드 시 실제 크기·비율 반영

### 요약
새로 올리는 이미지가 **항상 200×200 정사각형**으로 저장되던 문제를 수정했습니다. 이제 **실제 이미지 비율**을 읽어서 박스 크기에 반영하며, 긴 변이 **최대 600**이 되도록 스케일합니다.

### 수정 내용

#### 1.1 MediaService (`ink_talk/lib/services/media_service.dart`)
- **`getImageDimensions(Uint8List bytes)`** (static): `dart:ui`의 `ImageDescriptor.encoded`로 바이트만 보고 width/height 조회 (전체 디코딩 없음). 사용 후 `descriptor.dispose()` 호출.
- **`uploadImageBytes(roomId, bytes, fileName)`**: 이미 읽은 바이트로 업로드. 한 번 읽은 바이트로 크기 조회·업로드해 중복 읽기 방지.
- **`uploadImageFile`**: 내부에서 `readAsBytes()` 후 `uploadImageBytes` 호출하도록 정리.

#### 1.2 CanvasController (`ink_talk/lib/screens/canvas/canvas_controller.dart`) — `uploadImage`
- 파일에서 **한 번만** `readAsBytes()` 호출.
- **`MediaService.getImageDimensions(bytes)`**로 실제 픽셀 크기 조회 (실패 시 200×200 유지).
- 긴 변이 **600**이 되도록 비율 유지해 `displayW`, `displayH` 계산.
- **`uploadImageBytes`**로 같은 바이트 업로드.
- **`MediaModel`** 생성 시 `width: displayW`, `height: displayH` 사용.

### 결과
세로로 긴 사진은 세로로 긴 박스, 정사각형은 정사각형 박스로 올라가며, 크기 조정도 이 비율을 기준으로 동작합니다.

---

## 2. 크기 조정 시 캔버스 이동 비활성화 + 사진 밖 탭 시 크기 조정 취소

### 요약
**크기 수정**을 누르고 점(핸들)이 활성화된 상태에서 드래그 시 **캔버스가 움직여** 크기 조정이 어렵던 문제를 수정했습니다. 크기 조정 모드일 때는 **캔버스 이동을 끄고**, **사진에서 일정 범위 밖을 탭하면 크기 조정이 해제**되도록 했습니다.

### 수정 내용

#### 2.1 CanvasController
- **`isInMediaResizeMode`** getter 추가: `_mediaInResizeMode != null` 여부 반환.

#### 2.2 DrawingCanvas (`ink_talk/lib/widgets/canvas/drawing_canvas.dart`)
- **`_onScaleUpdate`**: 한 손가락으로 이동할 때 **`widget.controller.isInMediaResizeMode`**이면 **팬(캔버스 이동) 하지 않고 return**.
- **`_onTapUp`**: 크기 조정 모드일 때, 선택된 미디어의 **사진 영역 + 여유 32px**를 화면 좌표로 계산해, **탭한 위치가 그 밖**이면 `clearMediaResizeMode()` 호출 후 return.

### 결과
크기 수정 모드에서는 핸들만 드래그해 크기 조정이 되고, 사진에서 32px 이상 떨어진 빈 곳을 탭하면 크기 조정 모드가 해제됩니다.

---

## 3. 손글씨 시 사진 떨림 방지 + 사진 위에 글씨 쓰기

### 요약
펜으로 그릴 때 **사진 위를 지나가면 사진이 떨리며 움직이던 현상**을 없애고, **사진 위에 손글씨가 그려지도록** 레이어 순서를 바꿨습니다.

### 원인
- 미디어가 스택에서 캔버스 위에 있어, 펜 드래그가 미디어의 `GestureDetector`(팬/이동)로 잡혀 사진이 움직임.
- 스트로크가 미디어 아래 레이어에 그려져 사진 위에 글이 올라가지 않음.

### 수정 내용

#### 3.1 MediaWidget (`ink_talk/lib/widgets/canvas/media_widget.dart`)
- **`ignorePointer`** 파라미터 추가 (기본값 `false`).
- **`IgnorePointer(ignoring: widget.ignorePointer)`**로 감싸서, `true`일 때 터치/펜 이벤트가 미디어를 통과해 캔버스로 전달되도록 함.

#### 3.2 DrawingCanvas
- **`_mediaIgnorePointer(mediaId)`**: 펜1·펜2·지우개 모드이고, 해당 미디어가 **크기 조정 모드가 아닐 때** `true` 반환. 크기 수정 모드일 때는 포인터를 받아 핸들 드래그 가능.
- **MediaWidget**에 **`ignorePointer: _mediaIgnorePointer(media.id)`** 전달.
- **레이어 분리**
  - **아래 레이어** (`strokesOnly: false`): 배경, 격자, 도형, 태그 하이라이트만 그림.
  - **미디어** 위젯.
  - **위 레이어** (`strokesOnly: true`): 서버/로컬/고스트/현재 스트로크만 그림.

#### 3.3 _CanvasPainter
- **`strokesOnly`** 파라미터 추가 (기본값 `false`).
- **`strokesOnly == false`**: 배경·격자·도형·하이라이트만 그림 (스트로크 없음).
- **`strokesOnly == true`**: 변환(offset/scale)만 적용한 뒤 스트로크만 그림.

### 결과
펜/지우개로 그릴 때 사진이 움직이지 않고, 손글씨가 사진 위에 그려집니다.

---

## 4. 캔버스 확대/축소 비율에 따른 사진 이동 현상 수정

### 요약
**확대/축소 비율**을 바꿀 때 **사진이 어긋나며 이동**하던 현상을 수정했습니다. 줌 **버튼(±)** 사용 시 **캔버스 뷰포트와 동일한 좌표계의 중심**을 초점으로 쓰도록 했습니다.

### 원인
줌 버튼을 눌렀을 때 초점(focal point)으로 **전체 화면 중심** `(MediaQuery.size / 2)`를 사용하고 있었고, 실제 캔버스는 AppBar·툴바 아래 **Expanded** 영역이라 좌표계가 달라 줌 시 사진이 어긋나 보였습니다.

### 수정 내용

#### 4.1 CanvasController
- **`_viewportSize`**, **`viewportSize`** getter, **`setViewportSize(Size)`** 추가. 크기가 바뀔 때만 `notifyListeners()` 호출.
- **`getZoomFocalPoint(Size fallbackScreenSize)`**: 뷰포트 크기가 있으면 `(width/2, height/2)` 반환, 없으면 fallback의 중심 반환.

#### 4.2 DrawingCanvas
- 캔버스 영역을 **LayoutBuilder**로 감싸, **`controller.setViewportSize(Size(constraints.maxWidth, constraints.maxHeight))`**로 캔버스 뷰포트 크기를 컨트롤러에 전달.

#### 4.3 CanvasScreen — 줌 버튼
- **`_buildZoomControl`**: `MediaQuery.size` 중심 대신 **`_canvasController.getZoomFocalPoint(MediaQuery.sizeOf(context))`**를 사용해 캔버스 뷰포트 중심을 줌 초점으로 사용.

### 결과
± 버튼으로 줌할 때 캔버스 영역 중심을 기준으로 확대/축소되어, 비율에 따라 사진이 옆으로 이동하는 현상이 사라집니다. 핀치 줌은 기존대로 `localFocalPoint`를 사용합니다.

---

## 수정·추가된 파일 목록

| 파일 | 변경 요약 |
|------|-----------|
| `lib/screens/canvas/canvas_controller.dart` | isInMediaResizeMode, viewportSize·setViewportSize·getZoomFocalPoint, uploadImage 실제 크기 반영 |
| `lib/widgets/canvas/media_widget.dart` | ignorePointer 파라미터 추가 |
| `lib/widgets/canvas/drawing_canvas.dart` | ignorePointer 전달, 크기 조정 시 팬 비활성화·밖 탭 시 취소, 레이어 분리(strokesOnly)·LayoutBuilder·setViewportSize |
| `lib/services/media_service.dart` | getImageDimensions, uploadImageBytes, uploadImageFile 정리 |
| `lib/screens/canvas/canvas_screen.dart` | 줌 버튼 getZoomFocalPoint 사용 |

---

*보고서 작성일: 2025년 2월 5일*
