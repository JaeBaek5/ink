# 2026년 2월 12일 작업 보고서

오늘 진행한 툴바·선택 도구·텍스트 입력(위치 지정/빠른 텍스트) 관련 수정·추가 사항을 정리한 보고서입니다.

---

## 1. 진행한 작업 요약

### 1.1 툴바 — 자유형 선택·사각 선택·영상·사진·PDF·텍스트·손글씨 모두 선택 가능

- **요구사항**: 상단 툴바에서 자유형 선택, 사각 선택, 영상, 사진, PDF, 텍스트, 손글씨(펜)가 **항상 선택·탭 가능**하도록.
- **구현**:
  - **CanvasController**: `setInputMode(text/quickText/shape)` 시 `_selectionTool = SelectionTool.none`으로 선택 도구 해제. `selectSelectionTool(lasso/rectangle)` 시 `_inputMode = InputMode.pen`으로 설정해 텍스트/도형 모드에서도 선택 도구로 전환 가능.
  - **PenToolbar**: 첫 번째 펜 툴팁을 "손글씨 · 펜"으로 명시, 클래스 주석에 "자유형 선택, 사각 선택, 영상, 사진, PDF, 텍스트, 손글씨 모두 항상 선택·탭 가능" 명시.

**수정 파일**: `canvas_controller.dart`, `pen_toolbar.dart`

---

### 1.2 자유형/사각형 선택 — 손글씨뿐 아니라 사진·영상·PDF·텍스트까지 선택

- **요구사항**: 자유형 선택(라쏘) 또는 사각형 선택으로 **손글씨만** 선택되던 것을, **사진·영상·PDF·텍스트**도 함께 선택·삭제·복사·이동 가능하게.
- **구현**:
  - **선택 수집**: `endSelection()`에서 `_strokeIdsInSelection()` 외에 `_mediaIdsInSelection()`, `_textIdsInSelection()` 호출해 선택 영역(올가미/사각형) 내 미디어 ID·텍스트 ID를 수집. `_selectedMediaIds`, `_selectedTextIds` 추가.
  - **삭제**: `deleteSelection()` — 선택된 손글씨·미디어·텍스트 일괄 삭제.
  - **복사**: `copySelection()` — 손글씨 오프셋 복사, 미디어는 `duplicateMedia`, 텍스트는 동일 내용으로 새 텍스트 추가(위치 오프셋).
  - **이동**: `startMovingSelection` / `updateMovingSelection` / `endMovingSelection`에서 선택된 미디어(`moveMedia`), 텍스트(위치 업데이트 후 `_textService.updateText`)까지 함께 이동. `isPointOnSelectedSelection()`으로 손글씨·미디어·텍스트 위 터치 시 이동 시작.
  - **UI**: 선택된 미디어·텍스트에 금색 테두리 하이라이트. 툴바 선택 바에 "N개 선택"(손글씨+미디어+텍스트 합산), 삭제/복사/선택 해제는 통합 동작.

**수정 파일**: `canvas_controller.dart`, `drawing_canvas.dart`, `pen_toolbar.dart`

---

### 1.3 텍스트(위치 지정) — 캔버스 커서 위치에 글 쓰기

- **요구사항**: 텍스트 입력 모드일 때 **손가락으로 누른 위치**에 커서가 깜빡이고, 그 위치에 글이 써지도록.
- **구현**:
  - **CanvasController**: `_textCursorPosition`, `setTextCursorPosition(Offset?)`, `clearTextCursorPosition()`. 탭 시 위치 저장, 다이얼로그 닫을 때 해제.
  - **DrawingCanvas**: 텍스트 모드에서 캔버스 탭 시 `setTextCursorPosition(localPoint)` 후 텍스트 입력 다이얼로그 표시. `textCursorPosition != null`일 때 해당 위치(캔버스→화면 좌표 변환)에 **깜빡이는 커서**(`_BlinkingCursor`) 표시. 다이얼로그 `then`에서 `clearTextCursorPosition()` 호출.
  - **위치 지정 텍스트** 추가 시 `addText(content, position)`에 탭한 `position` 전달해 해당 위치에 텍스트 배치.

**수정 파일**: `canvas_controller.dart`, `drawing_canvas.dart` (위치 지정 텍스트 커서 + 빠른 텍스트 커서 화면 좌표 보정)

---

### 1.4 빠른 텍스트 입력 — 작동 방식 변경 (탭 위치·커서·전송 후 아랫줄)

- **요구사항**:
  1. 툴바에서 **빠른 텍스트 입력** 선택
  2. **손가락 한 개**로 캔버스 이동(팬)
  3. **원하는 위치를 탭** → 그곳에 **커서가 나와 깜빡임** (사용자가 “여기에 글이 써진다”고 인지)
  4. **키보드로 텍스트 입력 후 전송** → **커서 위치에 글 씀**
  5. **전송 후** 커서는 **글자 아랫줄**로 이동해 깜빡임 (연속 입력 가능)

- **구현**:
  - **CanvasController**:
    - `_quickTextCursorPosition` (nullable): 탭한 위치 또는 전송 후 다음 줄 위치. `null`이면 탭 전이라 커서 미표시.
    - `setQuickTextCursorPosition(Offset?)`: 캔버스 탭 시 호출.
    - **빠른 텍스트 모드 진입/해제** 시 `_quickTextCursorPosition = null` (탭 전에는 커서 없음, 모드 나갈 때 정리).
    - `addQuickText(content)`: 배치 위치 = `_quickTextCursorPosition ?? _lastTextPosition ?? (50, 100)`. `addText` 호출 후 `_quickTextCursorPosition = _lastTextPosition`로 설정해 **커서를 방금 쓴 글 아랫줄**로 이동.
  - **DrawingCanvas**:
    - 빠른 텍스트 모드에서 **캔버스 탭** 시 `setQuickTextCursorPosition(localPoint)` 호출.
    - `quickTextCursorPosition != null`일 때만 **깜빡이는 커서**(`_BlinkingCursor`) 표시, 캔버스→화면 좌표 변환 적용.

**수정 파일**: `canvas_controller.dart`, `drawing_canvas.dart`

---

## 2. 수정·추가된 파일 목록

| 파일 | 변경 요약 |
|------|------------|
| `ink_talk/lib/screens/canvas/canvas_controller.dart` | 툴바 모드 연동, 미디어/텍스트 선택·삭제·복사·이동, 위치 지정/빠른 텍스트 커서 위치 관리 |
| `ink_talk/lib/widgets/canvas/drawing_canvas.dart` | 선택 하이라이트(미디어·텍스트), 위치 지정/빠른 텍스트 탭 시 커서 설정, 깜빡이는 커서(`_BlinkingCursor`), 화면 좌표 변환 |
| `ink_talk/lib/widgets/canvas/pen_toolbar.dart` | 손글씨 툴팁, 통합 선택 개수·삭제·복사·해제, `hasSelectedStrokesOrMediaOrText` 사용 |

---

## 3. 참고 사항

- **선택 도구**: 자유형/사각형 선택 후 손글씨·미디어·텍스트가 섞여 있어도 한 번에 삭제·복사·이동 가능.
- **텍스트 커서**: 위치 지정 텍스트는 “탭 → 커서 표시 → 다이얼로그에서 입력 → 해당 위치에 배치”. 빠른 텍스트는 “탭 → 커서 표시 → 하단 입력창에서 입력·전송 → 커서 위치에 배치 후 커서는 아랫줄로 이동”.

---

*작성일: 2026년 2월 12일*
